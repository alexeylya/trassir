# TRASSIR SDK Документация

## Введение

Открытая платформа TRASSIR позволяет легко интегрировать сторонние приложения. Набор средств для взаимодействия называется SDK.

Хотя SDK предназначен для использования в программах, все функции работают из браузера. Более того, в комментариях SDK подсказывает какие еще функции можно вызвать, Вам остается только скопировать пример в строку адреса. Испытывайте все функции с помощью браузера!

### Предупреждение

Обратите внимание, что перед использованием SDK необходимо предварительно выполнить настройку сервера.

Функции SDK возвращают ответ в формате JSON. Библиотеки для работы с JSON есть в любом языке программирования. Если решаемая задача не требует точного разбора ответов, можно легко обойтись регулярными выражениями, именно такой способ используется в качестве примеров на языке python.

Существует два варианта работы с SDK — через пароль SDK и с помощью указания логина\пароля произвольного пользователя существующего в системе. Также, можно, а в ряде случаев необходимо (например при просмотре архива), вести работу с получением сессии. Выбирать тот или иной способ следует исходя из конкретной задачи.

## Настройка сервера для работы с SDK

Для того, чтобы включить возможность обращаться к серверу TRASSIR через SDK, поставьте флаг SDK.

В зависимости от того функционала, который планируется использовать, необходимо поставить флаги: Дерево объектов, Вызов методов, События, События POS, События AutoTRASSIR, Чтение настроек, Скриншоты, Управление PTZ. Ссылки рядом с пунктами можно использовать для быстрой проверки работоспособности того или иного функционала SDK и как подсказку к синтаксису [команд](sdk-commands.html). Если планируется получать видео с сервера или проигрывать архив, то установите флаги: FLV, JPEG, MJPEG.

В поле Пароль к SDK нужно ввести произвольный пароль, который будет использоваться для получения сессии или отправки команд при работе через пароль SDK. При необходимости, вы можете изменить Порт, который будет использоваться для подключения к серверу. Значение по умолчанию 8080.

В настройках пользователя, который будет использоваться при работе с SDK, должен быть установлен флаг Разрешить подключение с мобильного/из браузера и установлены права на использование нужного вам функционала. При работе через указание пароля SDK необходимо настроить нужные права для служебного пользователя Script.

### Подсказка

Подробнее о настройках прав пользователей читайте в "Руководстве администратора".

## Общий вид запроса

В зависимости от задачи, Вы можете работать с SDK через указание пароля SDK, явное указание логина\пароля произвольного пользователя в каждом запросе, либо использовать сессии.

Если в запросе не указать имя пользователя, а указать только пароль, то система будет считать что работа ведется через пароль SDK с правами пользователя Script, если имя пользователя будет указано, то работа будет вестись с правами этого пользователя. Для того, чтобы каждый раз не передавать логин и пароль в запросе, Вы можете использовать сессии, кроме того некоторые команды требуют обязательного наличия сессии.

Общий вид запроса с указанием пароля SDK:

```
https://адрес_сервера:порт/команда?password=пароль
```

Общий вид запроса с указанием логина\пароля произвольного пользователя:

```
https://адрес_сервера:порт/команда?username=пользователь&password=пароль
```

Общий вид запроса с использованием сессии:

```
https://адрес_сервера:порт/команда?sid=id_сессии
```

Ключевые элементы запроса:

- адрес_сервера - ip-адрес сервера в формате Ipv4, либо его NetBios-имя, пример: 192.168.1.1 , либо videoserver ;
- порт - порт сервера для подключения к SDK, пример: 8080 ;
- команда - сам запрос, который необходимо выполнить, пример: health ;
- пользователь - имя пользователя, под которым будет вестись работа, пример: Admin ;
- пароль - пароль пользователя, пример: 987654321 ;
- id_сессии - id полученной сессии, пример: e03qD0eg ;

### Подсказка

Обратите внимание, что запрос обязательно должен начинаться с https:// (работа идет по протоколу HTTPS).

Примеры запросов:

```
https://192.168.1.200:8080/health?username=Admin&password=987654321
https://192.168.1.200:8080/health?password=12345
https://192.168.1.200:8080/health?sid=e03qD0eg
```

В примерах запросов описанных выше данные передаются на сервер методом GET. Так же, Вы можете использовать метод передачи POST. Ниже приведен пример простой html-формы иллюстрирующий этот принцип:

```
<html>
    <body>
        <form action="https://192.168.1.200:8000/objects/" method="POST">
        <label for="password">Введите пароль SDK:</label>
        <input id="password" type="password" name="password">
        <input type="submit" value="Отправить">
        </form>
    </body>
</html>
```

Далее, в [рассматриваемых примерах](sdk-examples.html) везде будет использоваться метод передачи GET с использованием сессии.

## Команды используемые при работе с SDK

В зависимости от того под каким пользователем идет работа список доступных команд будет отличаться, при этом ряд команд требует обязательной работы через сессию. Ниже в таблице перечислены возможные команды, требования к использованию сессий и доступность функционала в зависимости от выбранного типа работы.

| Команда | Описание | Использование сессии | Пароль SDK | Произвольный пользователь |
|---------|----------|----------------------|------------|---------------------------|
| /login | создание новой сессии | Необязательно | + | + |
| /health | вывод состояния “здоровья” сервера | Необязательно | + | + |
| /settings | чтение и запись настроек сервера | Необязательно | + | + |
| /objects | вывод дерева объектов сервера<br><br>применение различных методов к объектам сервера | Необязательно | + | - |
| /classes | вывод описания классов объектов сервера | Необязательно | + | - |
| /users | создание пользователей и групп пользователей | Необязательно | + | - |
| /channels | быстрый вывод списка каналов | Обязательно | - | + |
| /events | получение событий сервера | Необязательно | + | - |
| /pos_events | получение событий POS-терминалов | Необязательно | + | - |
| /lpr_events | получение событий AutoTRASSIR | Необязательно | + | - |
| /fr_events | получение событий трекера/распознавателя лиц | Обязательно | + | - |
| /deep_detector | получение событий нейронного детектора объектов | Обязательно | + | - |
| /screenshot | запрос скриншота | Необязательно | + | - |
| /ptz | управление ptz-камерой | Обязательно | - | + |
| /archive_status | вывод состояния архива | Обязательно | - | + |
| /archive_command | управление архивом | Обязательно | - | + |
| /archive_events | запрос событий архива | Обязательно | - | + |
| /get_video | получение ссылки на видео | Обязательно | - | + |
| /archive_export<br><br>/archive_export_ss<br><br>/archive_export_ex<br><br>/export_archive<br><br>/export_task<br><br>/export_cancel | локальный экспорт архива | Обязательно | + | + |
| /jit-export-task<br><br>/jit-export-status<br><br>/jit-export-download<br><br>/jit-export-cancel-task | удаленный экспорт архива | Обязательно | + | + |

### Подсказка

При работе с указанием логина/пароля в запросе, ответ сервера на команды /events, /pos_events, /lpr_events и /fr_events каждый раз будет содержать последние 100 событий.

При работе через сессию первый запрос вернет последние 100 событий, а все последующие запросы будут возвращать только новые события произошедшие со времени последнего запроса. Если долгое время событий не происходит, то наступит тайм-аут.

### Подсказка

Обратите внимание, что SDK не осуществляет поиск по БД событий, а возвращает лишь те события, которые были накоплены с момента старта модуля автоматизации.

Также, рекомендуем вам ознакомиться с более подробным [описанием команд и примерами их использования](sdk-examples.html).

## Получение id сессии

Получить id сессии возможно двумя способами: указав пароль SDK, либо указав логин\пароль произвольного пользователя. Какой способ выбрать зависит от [конкретной задачи](sdk-commands.html). Для получения id сессии служит команда /login.

Пример запроса с указанием пароля SDK:

```
https://192.168.1.200:8080/login?password=12345
```

Пример запроса с указанием логина\пароля произвольного пользователя:

```
https://192.168.1.200:8080/login?username=Admin&password=987654321
```

В обоих случаях ответ будет иметь один и тот же вид:

```
{
"success" : 1,
"sid" : "e03qD0eg"
}
```

В данном примере ответ содержит:

* "success" : 1 - сообщение что авторизация прошла успешно;
* "sid" : "e03qD0eg" - уникальный id сессии;

В случае указания неверных данных авторизации, ответ будет иметь вид:

```
{
    "success" : "0",
    "error_code" : "invalid username or password"
}
/*
Username and Password should match to one of the server users.
*/
```

### Важно

Время жизни сессии равно 15 минутам, и при отсутствии постоянных запросов она "умирает". Любой запрос, выполненный в течение жизни этой сессии, с использованием одного и того же sid обновит ее время жизни до 15 минут.

### Важно

В WEB-сервер встроены следующие виды защиты от несанкционированного доступа:

- Защита от большого количества подключений с одного IP-адреса. К SDK можно осуществить не более 99 подключений с одного IP адреса. Все подключения свыше этого лимита будут отклонены, а в журнале TRASSIR появится соответствующая запись.
- Защита от частой авторизации. WEB-сервер позволяет производить запрос sid не чаще одного раза в течение 5 секунд. Слишком частые попытки отправить запрос могут привести к блокировке IP-адреса.

## Запрос дерева объектов

Все устройства, которые присутствуют в системе, представлены в виде дерева объектов. Для его получения используется команда /objects/. Обратите внимание на «/» на конце, его использование обязательно.

Пример запроса:

```
https://192.168.1.200:8080/objects/?sid=gbnVFUit
```

Пример ответа сервера:

```
[
    {
        "name" : "Проходная",
        "guid" : "MBZZ3Y3o",
        "class" : "Channel",
        "parent" : "shMa536E"
    },
    {
        "name" : "a-maltsev",
        "guid" : "UQS60Nr1",
        "class" : "Server",
        "parent" : "UQS60Nr1"
    },
    {
        "name" : "Интерфейс оператора a-maltsev",
        "guid" : "operatorgui_UQS60Nr1",
        "class" : "OperatorGUI",
        "parent" : "UQS60Nr1"
    },
    {
        "name" : "DS-2CD8153F-E",
        "guid" : "shMa536E",
        "class" : "IP Device",
        "parent" : "UQS60Nr1"
    },
    {
        "name" : "2x2",
        "guid" : "JM07fBTb",
        "class" : "Template",
        "parent" : "operatorgui_UQS60Nr1"
    }
]
```

| Свойства | Значения | Описание свойства | Версия ПО |
| "name" |  | Имя объекта в системе. | ≥3.2 |
| "guid" |  | Уникальный идентификатор объекта. | ≥3.2 |
| "class" | "Server" - класс подключенных серверов<br><br>"IP Device" - класс IP устройств<br><br>"Channel" - класс каналов<br><br>"OperatorGUI" - класс интерфейса оператора<br><br>"Template" - класс шаблонов<br><br>и др. | Класс, которому принадлежит объект, определяет возможные параметры и статусы, которые может иметь объект. | ≥3.2 |
| "parent" |  | Показывает отношения между объектами.<br><br>В рассмотренном примере объект канал Проходная принадлежит объекту ip-камере DS-2CD8153F-E, которая в свою очередь принадлежит объекту серверу a-maltsev. | ≥3.2 |

## Запрос описания классов объектов сервера

Каждый объект сервера принадлежит тому или иному классу(типу). Класс описывает возможные состояния объекта и методы, которые к нему применимы. Существует множество различных классов и чтобы узнать какому классу принадлежит объект, воспользуйтесь командой [/objects](sdk-examples-tree.html). Для запроса параметров класса используется команда /classes.

Пример запроса:

```
https://192.168.1.200:8080/classes/Channel?sid=gbnVFUit
```

### Подсказка

Обратите внимание, что названия классов (в нашем примере Channel) регистрозависимы.

Пример ответа сервера:

```
{
    "possible_states_vector" : [
        {
            "name" : "signal",
            "values" : [
                    "No Signal",
                    "Signal"
            ]
        },
        {
            "name" : "motion",
            "values" : [
                    "No Motion",
                    "Motion"
            ]
        },
        {
            "name" : "recording",
            "values" : [
                    "Not Recording",
                    "Recording"
            ]
        },
        {
            "name" : "recording_on_device",
            "values" : [
                    "Not Recording (on device)",
                    "Recording (on device)"
            ]
        },
        {
            "name" : "sound_detector",
            "values" : [
                "Disabled",
                "Silent",
                "Loud"
            ]
        }
    ],
    "methods" : [
        {
            "name" : "record",
            "parameters" : [
                {
                    "name" : "turn_on_record",
                    "type" : "integer"
                }
            ]
        },
        {
            "name" : "record_on",
            "parameters" : [
            ]
        },
        {
            "name" : "record_off",
            "parameters" : [
            ]
        },
        {
            "name" : "set_watermark",
            "parameters" : [
                {
                    "name" : "watermark_text",
                    "type" : "string"
                },
                {
                    "name" : "watermark_position",
                    "type" : "integer"
                },
                {
                    "name" : "timestamp_position",
                    "type" : "integer"
                }
            ]
        },
        {
            "name" : "manual_record_start",
            "parameters" : [
            ]
        },
        {
            "name" : "manual_record_stop",
            "parameters" : [
            ]
        },
        {
            "name" : "ptz_preset",
            "parameters" : [
                {
                    "name" : "preset_n",
                    "type" : "integer"
                }
            ]
        },
        {
            "name" : "screenshot",
            "parameters" : [
            ]
        },
        {
            "name" : "screenshot_ex",
            "parameters" : [
                {
                    "name" : "timestamp",
                    "type" : "string"
                },
                {
                    "name" : "directory",
                    "type" : "string"
                }
            ]
        },
        {
            "name" : "screenshot_v2",
            "parameters" : [
                {
                    "name" : "time_YYYYMMDD_HHMMSS",
                    "type" : "string"
                },
                {
                    "name" : "screenshot_filename",
                    "type" : "string"
                },
                {
                    "name" : "screenshot_folder",
                    "type" : "string"
                },
                {
                    "name" : "make_thumb",
                    "type" : "integer"
                }
            ]
        }
    ]
}
```

В данном примере ответ содержит:

```
"possible_states_vector" : [
    {
        "name" : "signal",
        "values" : [
                "No Signal",
                "Signal"
        ]
    }
]
```

* "possible_states_vector" - блок описания статусов объекта данного класса и их возможных состояний;
* "name" : "signal" - имя статуса, в данном примере описывает наличие сигнал по каналу;
* "values" : - возможные значения, в данном примере: "No Signal" – нет сигнала, "Signal" – сигнал есть.

В данном примере ответ содержит:

```
"methods" : [
    {
        "name" : "ptz_preset",
        "parameters" : [
            {
                "name" : "preset_n",
                "type" : "integer"
            }
        ]
    }
]
```

* "methods" : - блок описания методов применимых к объекту данного класса;
* "name" : "ptz_preset" - имя метода, в данном примере переход PTZ камеры на определенную предустановку (preset) камеры;
* "parameters" : - параметры, которые необходимо передать;
* "name" : "preset_n", "type" : "integer" - имя параметра и его тип, в данном примере номер предустановки камеры, формат — целое число.

## Применение методов к объектам сервера

К каждому объекту сервера может применяться метод, [соответствующий классу](sdk-examples-classes.html), к которому принадлежит этот объект. Для того, чтобы узнать какому классу принадлежит объект, воспользуйтесь командой [/objects](sdk-examples-tree.html). Для запроса параметров класса используется команда /classes.

Пример вызова метода:

```
https://192.168.1.200:8080/objects/operatorgui_CyPy6vF5/change_view_settings?name=opts_common_show_channel_name&value=1&sid=gbnVFUit
```

Запрос содержит:

* operatorgui_CyPy6vF5 - объект, в данном примере принадлежащий классу "OperatorGUI" (интерфейс оператора);
* change_view_settings - метод класса "OperatorGUI", изменяющий настройки внешнего вида отображаемого канала;
* name=opts_common_show_channel_name - параметр изменяемый методом, в данном примере - отображение название канала;
* value=1 - значение, присваиваемое параметру.

Пример ответа сервера:

```
{
    "success" : "1"
}
```

## Чтение и запись настроек сервера

Настройки объектов сервера представлены в виде дерева с вложенными папками. При отправке команды /settings/ сервер вернет в ответ дерево подпапок, описывающее все настройки сервера. Обратите внимание на «/» на конце.

Пример запроса:

```
https://192.168.1.200:8080/settings/?sid=e03qD0eg
```

Пример ответа сервера:

```
{
    "name" : "CyPy6vF5",
    "type" : "LocalServer",
    "subdirs" : [
        "ad",
        "archive",
        "audit",
        "auto_trassir",
        "boards",
        "channels",
        "cloud",
        "eskuel",
        "fortnet-k0DMhmOb",
        "gate-EHukOXSy",
        "health",
        "ip_cameras",
        "map",
        "netrec",
        "network",
        "orion",
        "pos_folder2",
        "reports",
        "screenshots",
        "scripts",
        "serialports",
        "sphinx-LrzsfxDr",
        "system_wide_options",
        "templates",
        "users",
        "webserver"
    ],
    "values" : [
        "name",
        "folder",
        "icon",
        "media_route"
    ]
}
```

### Предупреждение

Будьте внимательны, в названиях некоторых папок используется уникальный идентификатор. Как правило это папки подключенных в TRASSIR СКУД.

Для того, чтобы изменить те или иные настройки сервера, вам необходимо знать точный путь где лежит требуемая настройка. Его легко узнать выполняя последовательно команды и переходя на нужный уровень подпапок. Например, для того, чтобы узнать значение битрейта указанного в настройках главного потока камеры, необходимо выполнить запрос вида:

```
https://192.168.1.200:8080/settings/ip_cameras/shMa536E/channel00_video_bitrate?sid=e03qD0eg
```

В запросе:

* ip_cameras - папка, в которой содержатся настройки всех ip-устройств системы;
* shMa536E - уникальный guid устройства;
* channel00_video_bitrate - конечный требуемый параметр настройки.

Пример ответа сервера:

```
{
        "directory" : "ip_cameras/shMa536E/",
        "name" : "channel00_video_bitrate",
        "type" : "integer",
        "value" : "2048"
}
```

Для изменения битрейта потока необходимо передать новое значение параметра используя знак "=":

```
https://192.168.1.200:8080/settings/ip_cameras/shMa536E/channel00_video_bitrate=8192?sid=e03qD0eg
```

Пример ответа сервера:

```
{
        "success" : "1"
}
```

Новое значение применено, проверить это можно повторно отправив команду:

```
https://192.168.1.200:8080/settings/ip_cameras/shMa536E/channel00_video_bitrate?sid=e03qD0eg
```

## Запрос состояния здоровья сервера

Примеры запросов:

```
https://192.168.1.200:8080/health?sid=e03qD0eg
```

или:

```
https://192.168.1.200:8080/health?password=12345
```

где:

* sid=e03qD0eg - id сессии;
* password=12345 - пароль SDK.

Пример ответа сервера:

```
{
    "disks": "1",
    "database": "1",
    "channels_total": "10",
    "channels_online": "5",
    "uptime": "12902",
    "cpu_load": "22.50",
    "network": "1",
    "automation": "1",
    "disks_stat_main_days": "56.15",
    "disks_stat_priv_days": "35.03",
    "disks_stat_subs_days": "40.20"
}
```

| Свойства | Значения | Описание свойства | Версия ПО |
| --- | --- | --- | --- |
| "disks" | "0" - ошибки есть<br>"1" - ошибок нет | Наличие ошибок при работе дисков сервера | ≥3.1 |
| "database" | "0" - ошибки есть<br>"1" - ошибок нет | Наличие ошибок при подключении к базе данных сервера | ≥3.1 |
| "channels_total" |  | Общее количество подключенных камер | ≥3.1 |
| "channels_online" |  | Количество камер, работающих без ошибок | ≥3.1 |
| "uptime" |  | Время работы сервера, в сек | ≥3.1 |
| "cpu_load" | от "1.00" до "100.00" | Текущая загрузка центрального процессора сервера, в % | ≥3.1 |
| "network" | "0" - ошибки есть<br>"1" - ошибок нет | Наличие ошибок в сетевых подключениях к другим серверам | ≥3.1 |
| "automation" | "0" - ошибки есть<br>"1" - ошибок нет | Наличие ошибок при выполнении скриптов на данном сервере | ≥3.1 |
| "disks_stat_main_days" |  | Текущая глубина архива основного потока, в днях | ≥3.1 |
| "disks_stat_priv_days" |  | Текущая глубина архива привилегированных каналов, в днях | ≥3.1 |
| "disks_stat_subs_days" |  | Текущая глубина архива дополнительного потока, в днях | ≥3.1 |

## Запросы для добавления новых пользователей и групп пользователей

Запросы для создания группы пользователей должны быть выполнены в следующем порядке:

```
https://[адрес_сервера]:[порт]/settings/users/user_add/new_group_name=[имя_группы]?sid=[id_сессии]
https://[адрес_сервера]:[порт]/settings/users/user_add/create_group_now=1?sid=[id_сессии]
```

Ответ, получаемый после каждого запроса:

```
{
	"success" : "1"
}
```

Запросы для создания пользователя должны быть выполнены в следующем порядке:

```
https://[адрес_сервера]:[порт]/settings/users/user_add/new_user_name=[имя_пользователя]?sid=[id_сессии]
https://[адрес_сервера]:[порт]/settings/users/user_add/new_user_password=[пароль_пользователя]?sid=[id_сессии]
https://[адрес_сервера]:[порт]/settings/users/user_add/create_now=1?sid=[id_сессии]
```

### Важно

[пароль_пользователя] не может быть пустым.

Ответ, получаемый после каждого запроса:

```
{
	"success" : "1"
}
```

Запрос для удаления пользователя:

```
https://[адрес_сервера]:[порт]/settings/users/user_add/delete_user_id=[id_пользователя]?sid=[id_сессии]
```

Ответ:

```
{
	"success" : "1"
}
```

### Подсказка

Запросы для изменения настроек пользователей и групп пользователей описаны в разделе Описание настроек пользователей.

## Запрос скриншота

Для получения скриншота видеопотока используется команда screenshot.

Примеры запросов:

```
https://192.168.1.200:8080/screenshot/XjwUsj8w?sid=OhiEj3U
https://192.168.1.200:8080/screenshot/XjwUsj8w?figures=1&sid=OhiEj3U
https://192.168.1.200:8080/screenshot?channel=XjwUsj8w&figures=1&password=12345
```

В запросах используются следующие параметры:

* XjwUsj8w или channel=XjwUsj8w - GUID канала, с которого запрашивается скриншот;
* figures=1 - параметр, добавляющий фигуры на скриншот;
* sid=OhiEj3U - id сессии.

В качестве ответа на запрос будет получен кадр с указанного канала с фигурами на нем.

При подключении к нескольким серверам можно запросить скриншот с канала, подключенного к одному из них.

Пример запроса:

```
https://192.168.1.200:8080/screenshot?server=HTwUsj8I&channel=XjwUsj8w&sid=OhiEj3U
```

В запросе используются следующие параметры:

* server=HTwUsj8I - GUID сервера, с которого запрашивается скриншот;
* channel=XjwUsj8w - GUID канала на сервере;
* sid=OhiEj3U - id сессии.

В качестве ответа на запрос будет получен кадр с указанного канала на одном из подключенных серверов.

Для получения скриншота из архива используется та же команда screenshot с параметром timestamp, в котором передается дата и время.

Примеры запросов:

```
https://192.168.1.200:8080/screenshot/XjwUsj8w?timestamp=20140225T112001&sid=XOhiEj3I
https://192.168.1.200:8080/screenshot/XjwUsj8w?timestamp=20140225T11200&figures=1&sid=XOhiEj3I
https://10.16.16.89:8080/screenshot?channel=XjwUsj8w&timestamp=20140225T112001&figures=1&password=12345
```

В запросах используются следующие параметры:

- XjwUsj8w или channel=XjwUsj8w - GUID канала, с которого запрашивается скриншот;
- timestamp=20140225T112001 - время кадра сохраненного в архиве, указанное в одном из предложенных форматов:

  * YYYY-MM-DD HH:MM:SS
  * YYYY-MM-DDTHH:MM:SS
  * YYYYMMDD-HHMMSS
  * YYYYMMDDTHHMMSS
  * а так же в UNIX(10 знаков) и TIMESTAMP(16 знаков) форматах.

  ### Подсказка

  Если timestamp=0 или он не указан, то это означает, что запрашивается последний сохраненный кадр.

  ### Подсказка

  Время указывается с учетом часового пояса, настроенного на сервере.
- figures=1 - параметр, добавляющий фигуры на скриншот;
- sid=XOhiEj3I - id сессии.

В качестве ответа на запрос будет получен кадр с указанного канала.

## Запрос списка каналов

Пример запроса:

```
https://192.168.1.200:8080/channels?sid=zxRc8Y7w
```

Пример ответа сервера:

```
{
    "channels" : [
        {
            "guid" : "thwfBTDO",
            "name" : "AC-D4011",
            "rights" : "783",
            "codec" : "h264",
            "have_mainstream" : "1",
            "have_substream" : "1",
            "have_ptz" : "0"
        },
        {
            "guid" : "zXbI18iN",
            "name" : "AC-D6034",
            "rights" : "783",
            "codec" : "h264",
            "have_mainstream" : "0",
            "have_substream" : "0",
            "have_hardware_archive": "0",
            "have_ptz" : "0",
            "fish_eye": 0,
            "have_voice_comm": "1",
            "aspect_ratio": "auto",
            "flip": "",
            "rotate": "rotate90"
        }
    ],
    "remote_channels" : [
        {
            "guid" : "KYfarktm",
            "name" : "TR-D7101IR1",
            "rights" : "783",
            "codec" : "h264",
            "have_mainstream" : "1",
            "have_substream" : "1",
            "have_hardware_archive": "0",
            "have_ptz" : "0"
            "fish_eye": 0,
            "have_voice_comm": "0",
            "aspect_ratio": "16:9",
            "flip": "hmirror",
            "rotate": "",
            "server_name": "admin@vms.com",
            "server_guid": "CLDY-dba8d35263c06537"
        },
    ],
    "zombies" : [
        {
            "guid" : "exQtceka",
            "name" : "DS-2DF7284-A 1",
            "rights" : "783"
        },
        {
            "guid" : "jrR09DoE",
            "name" : "AC-D7121IR1v2 2",
            "netrec_server_name": "",
            "rights" : "783"
        }
    ],
    "templates" : [
        {
            "guid" : "JM07fBTb",
            "name" : "2x2",
            "columns" : "2",
            "rows" : "2",
            "channels" : [
                "kKHVfblS",
                "u8OU0fAD",
                "FxTH0kTi",
                "qKJHlC5I"
            ]
        }
    ]
}
/*
channel rights is a 16-bit mask of rights, as described below

        512       1
        |         |
0000 0000 0000 0000
       ||      ||||                                    
       ||      |||`--> view live video                 
       ||      ||`--> view archive                     
       ||      |`--> adjust minor params, start record 
       ||      `--> adjust major params like ip address
       |`--> export archive or make a screenshot       
       `--> PTZ control                                

*/
```

В данном примере ответ содержит:

* channels - каналы на локальном сервере;
* remote_channels - удалённые и облачные каналы;
* zombies - потерянные каналы;
* templates - шаблоны оператора.

| Свойства | Значения | Описание свойства | Версия ПО |
| --- | --- | --- | --- |
| "guid" |  | Уникальный идентификатор объекта | ≥3.1 |
| "name" |  | Имя объекта | ≥3.1 |
| "rights" |  | Права пользователя на канале | ≥3.1 |
| "codec" |  | Видео кодек на канале | ≥3.1 |
| "have_mainstream" | 0 - нет, 1 - да | На канале включена передана основного потока | ≥3.1 |
| "have_substream" | 0 - нет, 1 - да | На канале включена передача дополнительного потока | ≥3.1 |
| "have_hardware_archive" | 0 - нет, 1 - да | Доступен архив на устройстве | ≥3.1 |
| "have_ptz" | 0 - нет, 1 - да | На канале используется протокол PTZ | ≥3.1 |
| "fish_eye" | 0 - нет, 1 - да | Программный разворот изображения для fisheye-камер | ≥4.0 |
| "have_voice_comm" |  |  | ≥4.0 |
| "aspect_ratio" | auto , 4:3 , 16:9 | Соотношение сторон | ≥4.0 |
| "flip" | hmirror , vmirror | Отражение | ≥4.0 |
| "rotate" | rotate90 , rotate180 , rotate270 | Разворот | ≥4.0 |
| "server_name" |  | Имя сервера, на котором находится удалённый канал | ≥3.1 |
| "server_guid" |  | Уникальный идентификатор сервера | ≥3.1 |
| "netrec_server_name" |  | Имя сервера, на котором хранится архив потерянного канала | ≥3.1 |
| "columns" |  | Количество рядов в шаблоне | ≥3.1 |
| "rows" |  | Количество строк в шаблоне | ≥3.1 |
| "channels" |  | ID каналов, отображённых в шаблоне | ≥3.1 |

## Получение видео и аудиопотоков

Получение потоков в режиме реального времени в SDK устроено следующим образом:

0) На сервер отправляется команда запроса потока, содержащая в себе следующие обязательные параметры:

  channel - guid канала;

  stream - тип запрашиваемого потока:

  * main - основной поток;
  * sub - дополнительный поток;
  * archive_main - архив основного потока;
  * archive_sub - архив дополнительного потока.

  container - формат получаемого потока:

  - flv - поток в flash-формате;
  - jpeg - поток в виде одного кадра в формате JPG;
  - mjpeg - поток в формате MJPEG;
  - rtsp - RTSP поток;
  - hls - поток в формате HLS;
  - custom - аудиопоток.

  sid - уникальный id сессии.

  При необходимости в команду можно добавить дополнительные необязательные параметры:

  quality - качество сжатия потока от 0 до 100% для форматов JPG ( container=jpeg ) и MJPEG( container=mjpeg ).

  framerate - для формата MJPEG( container=mjpeg ) скорость получение потока (от 0 до 60000):

  * 0 - поток в реальном времени;
  * 60000 - поток со скоростью 1 кадр в минуту.

  audio - для формата RTSP( container=rtsp ) включить передачу аудиопотока вместе с видеопотоком ( audio=pcmu ).

  hw - логический параметр включающий запрос архива с устройства:

  * true - в потоке архива с устройства;
  * false - в потоке архива сервера.
1) В ответ сервер выдает уникальный Token с помощью которого формируется конечная строка для получения аудио- или видеопотоков.

### Подсказка

GUID канала можно узнать с помощью [запроса дерева объектов](sdk-examples-tree.html) /objects, либо с помощью команды быстрого [запроса списка каналов](sdk-examples-channels.html) /channels.

### Важно

Обратите внимание, что все команды относящиеся к получению видео: /channels, /archive_status, /archive_command, /get_video должны выполнять с использованием [сессии](sdk-examples-id.html) полученной под произвольным пользователем (НЕ через пароль от SDK).

Примеры запросов Token с канала channel=CKq5LLiO:

- получение основного видеопотока( stream=main) со скоростью 1 кадр/сек( framerate=1000), перекодированного в формат MJPEG( container=mjpeg) и качеством сжатия 80%( quality=80):

  ```
  https://192.168.1.200:8080/get_video?channel=CKq5LLiO&container=mjpeg&quality=80&stream=main&framerate=1000&sid=WP6IRcrQ
  ```
- получение RTSP потока( container=rtsp) дополнительного потока( stream=sub):

  ```
  https://192.168.1.200:8080/get_video?channel=CKq5LLiO&container=rtsp&stream=sub&sid=WP6IRcrQ
  ```
- получение архива основного потока( stream=archive_main) перекодированного в формат MJPEG( container=mjpeg):

  ```
  https://192.168.1.200:8080/get_video?channel=CKq5LLiO&container=mjpeg&stream=archive_main&sid=WP6IRcrQ
  ```
- получение аудио( container=custom) с основного потока ( stream=main):

  ```
  https://192.168.1.200:8080/get_video?channel=CKq5LLiO&container=custom&stream=main&sid=WP6IRcrQ
  ```

Пример ответа сервера:

```
    {
        "success" : 1,
        "token" : "c4Z0qkuu"
    }
```

В данном примере ответ содержит:

* "success" : 1 - сообщение что авторизация прошла успешно;
* "token" : "c4Z0qkuu" - уникальный Token для получения видео;

Примеры запросов на получение видео- и аудиопотоков:

- основного и дополнительного потоков и их архивов:

  ```
  http://192.168.1.200:555/c4Z0qkuu
  ```
- RTSP потока

  ```
  rtsp://192.168.1.200:555/c4Z0qkuu
  ```
- поток в формате HLS:

  ```
  https://192.168.1.200:8080/hls/c4Z0qkuu/master.m3u8
  ```
- аудиопотока:

  ```
  http://192.168.1.200:555/media/c4Z0qkuu?stream=audio&container=ogg&channels=2&bitrate=64000&samplerate=44100
  ```

В данных примерах запрос содержит:

* c4Z0qkuu - Token, полученный ранее;
* stream=audio - передавать аудиопоток;
* container=ogg - кодек аудиопотока (aac или ogg);
* channels=2 - количество каналов передаваемого аудиопотока;
* bitrate=64000 - степень сжатия аудиопотока;
* samplerate=44100 - частота дискретизации аудиопотока (8000, 11025, 16000, 22050, 24000, 32000, 44100 или 48000).

### Важно

Время жизни Token равно 10 сек и при отсутствии постоянных запросов он "умирает". Для продления его жизни, например, на паузе при просмотре архива или при просмотре видео с большим framerate, необходимо выполнить запрос:

```
http://192.168.1.200:555/c4Z0qkuu?ping
```

### Важно

Получение потока архива выполняется по следующему алгоритму:

0. Выполнить запрос Token с параметром container=archive_main или container=archive_sub.
1. По Token выполнить запрос потока.
2. С помощью [команд управления архивом](sdk-examples-archive.html) указать точку начала воспроизведения и запустить воспроизведение видео.

### Подсказка

Обратите внимание, что поток передается по протоколу http (перед ip-адресом указывается http://) и по порту 555 (порт потокового вещания можно изменить в [настройках сервера](sdk-setup.html)). Для получения потока по протоколу RTSP (перед ip-адресом указывается rtsp://) и так же используется порт 555.

## Запрос событий сервера

Пример запроса:

```
https://192.168.1.200:8080/events?sid=zxRc8Y7w
```

Пример ответа сервера:

```
[
    {
        "timestamp" : "1393398252126919",
        "type" : "Motion Start",
        "origin" : "bN8mjs2L"
    },
    {
        "timestamp" : "1393398252201923",
        "type" : "Motion Stop",
        "origin" : "bN8mjs2L"
    },
    {
        "timestamp" : "1393398259196323",
        "type" : "Smoke Detected",
        "origin" : "yAdY84gR"
    },
    {
        "timestamp" : "1393398261689466",
        "type" : "Object Size Alarm",
        "origin" : "FRi0Xbcb"
    },
    {
        "timestamp" : "1393398263778585",
        "type" : "Smoke Stopped",
        "origin" : "yAdY84gR"
    },
    {
        "timestamp": "1571919747381928",
        "type": "Login Successful, %1 from %2",
        "origin": "fFa27WVD",
        "username": "Admin",
        "ip_address": "localhost"
    },
    {
        "timestamp": "1571919747382135",
        "type": "Connected To %1 under %2",
        "origin": "fFa27WVD",
        "server_address": "EXP-US-H6 (172.16.13.85)",
        "under_username": "Admin"
    }
]
```

| Свойства | Значения | Описание свойства | Версия ПО |
| "timestamp" |  | Время возникновения события. | ≥3.2 |
| "type" | "Signal Lost", "Object Size Alarm", "Motion Start", "No Connection to Cloud" и др. | Тип события. | ≥3.2 |
| "origin" |  | GUID объекта к которому относится данное событие. | ≥3.2 |
| "server_address" |  | Имя или IP адрес удалённого сервера, на котором произошло событие. | ≥3.2 |
| "under_username" |  | Имя пользователя, авторизованного на удалённом на сервере. | ≥3.2 |
| "username" |  | Имя пользователя, авторизованного на локальном сервере. | ≥3.2 |
| "ip_address" |  | IP адрес локального сервера, на котором произошло событие. | ≥3.2 |

### Подсказка

Время в ответе указывается в микросекундах в формате [UNIX-время](https://en.wikipedia.org/wiki/Unix_time) с учетом часового пояса, настроенного на сервере.

## Запрос событий AutoTRASSIR

Примеры запросов:

```
https://192.168.1.200:8080/lpr_events?password=12345
https://192.168.1.200:8080/lpr_events?sid=zxRc8Y7w
https://192.168.1.200:8080/lpr_events?sid=zxRc8Y7w&dedup_timeout_sec=5
```

В запросах используются следующие параметры:

- password=12345 - пароль SDK;
- sid=zxRc8Y7w - id сессии;
- dedup_timeout_sec=5 - параметр, который предотвращает повторную публикацию события с одинаковым автомобильным номером, если оно произошло в течение заданного времени (например, 5 секунд) после предыдущего. Параметр работает только в режиме, когда авторизация происходит с использованием параметра sid.

Пример ответа сервера:

```
[
{
    "best_guess" : "b663kt777",
    "channel" : "ilL0UhRy",
    "flags" : "1073741825",
    "id" : "63191",
    "lane" : "2",
    "lists" : "",
    "plate" : "b663kt777",
    "quality" : "98.90",
    "server" : "CyPy6vF5",
    "speed" : "0.00",
    "template" : "ru/rux3xx3-v1",
    "time_bestview" : "1393329818921734",
    "time_enter" : "1393329818802482",
    "time_leave" : "1393329819239768",
    "track_points" : [],
    "vehicle_type" : "car"
},
{
    "best_guess" : "p066ok77",
    "channel" : "ilL0UhRy",
    "flags" : "2147483717",
    "id" : "63190",
    "lane" : "1",
    "lists" : "",
    "plate" : "p066ok77",
    "quality" : "65.60",
    "server" : "CyPy6vF5",
    "speed" : "0.00",
    "template" : "ru/rux3xx2-v1",
    "time_bestview" : "1393329818524229",
    "time_enter" : "1393329818524229",
    "time_leave" : "1393329818762729",
    "track_points" : [],
    "vehicle_type" : "car"
}
]
```

| Свойства | Значения | Описание свойства | Версия ПО |
|----------|----------|-------------------|------------|
| "best_guess" |  | Наиболее качественно распознанный автомобильный номер | ≥4.0 |
| "channel" |  | GUID канала, на котором используется модуль AutoTRASSIR | ≥3.1 |
| "flags" |  | Флаги, описывающие событие. | ≥3.1 |
| "id" |  | ID события AutoTRASSIR | ≥3.1 |
| "lane" |  | Полоса движения | ≥3.1 |
| "lists" |  | Список, в котором обнаружен данный номер автомобиля | ≥3.1 |
| "plate" |  | Распознанный AutoTRASSIR номер автомобиля | ≥3.1 |
| "quality" |  | Наилучший показатель качества распознавания номера автомобиля | ≥3.1 |
| "server" |  | ID сервера | ≥3.1 |
| "speed" |  | Скорость автомобиля | ≥3.1 |
| "template" |  | Шаблон AutoTRASSIR, использованный для определения номера автомобиля | ≥3.1 |
| "time_bestview" |  | Время в момент которого номер автомобиля распознается наиболее качественно | ≥3.1 |
| "time_enter" |  | Время появления номера автомобиля в области распознавания | ≥3.1 |
| "time_leave" |  | Время исчезновения номера автомобиля в области распознавания | ≥3.1 |
| "track_points" |  | Координаты распознанных номеров. Пример запроса для получения координат описан ниже | ≥3.1 |
| "vehicle_type" | car , motorcycle , bus , truck , van | Тип кузова распознанного транспортного средства | ≥4.5 |

### Подсказка

Время в ответе указывается в микросекундах в формате [UNIX-время](https://en.wikipedia.org/wiki/Unix_time) с учетом часового пояса, настроенного на сервере.

Параметр flags содержит описание события AutoTRASSIR: направление движения, номер полосы и название списка, в котором содержится распознанный номер. Каждое событие описывается при помощи битовой маски, в которой каждый бит отвечает за определенную информацию о распознанном номере.

| Номер бита | Значения | Название флага | Описание |
|------------|----------|----------------|----------|
| 0 | +1 | LPR_UP | Направление движения вверх |
| 1 | +2 | LPR_DOWN | Направление движения вниз |
| 2 | +4 | LPR_BLACKLIST | Номер в чёрном списке |
| 3 | +8 | LPR_WHITELIST | Номер в белом списке |
| 4 | +16 | LPR_INFO | Номер в информационном списке |
| 5 | +32 | LPR_EXT_DB_ERROR | Ошибка во внешнем списке |
| 6 | +64 | LPR_CORRECTED | Номер исправлен оператором |
| 29 | +536 870 912 | LPR_FIRST_LANE | Автомобиль двигается по первой полосе |
| 30 | +1 073 741 824 | LPR_SECOND_LANE | Автомобиль двигается по второй полосе |
| 29,30 | +1 610 612 736 | LPR_THIRD_LANE | Автомобиль двигается по третьей полосе |

Флаги в примере выше означают следующее:

* 1073741825 - сумма значений (1+1073741824), соответствует состояниям LPR_UP и LPR_SECOND_LANE, то есть транспортное средство с данным номером движется по второй полосе вверх.
* 1610612805 - сумма значений (1+4+64+1610612736), соответствует состояниям LPR_UP, LPR_INFO, LPR_CORRECTED и LPR_THIRD_LANE, то есть транспортное средство с данным номером движется по второй полосе вверх, номер транспортного средства после обнаружения был отредактирован оператором и найден в информационном списке.

Чтобы получить координаты распознанных номеров, добавьте к запросу `&track_points=true`.

Пример запроса событий AutoTRASSIR с координатами распознанных номеров:

```
https://192.168.1.200:8080/lpr_events?sid=zxRc8Y7w&track_points=true
```

Пример ответа сервера:

```
[
{
    "best_guess" : "b663kt777",
    "channel" : "ilL0UhRy",
    "flags" : "1073741825",
    "id" : "63191",
    "lane" : "2",
    "lists" : "",
    "plate" : "b663kt777",
    "quality" : "98.90",
    "server" : "CyPy6vF5",
    "speed" : "0.00",
    "template" : "ru/rux3xx3-v1",
    "time_bestview" : "1393329818921734",
    "time_enter" : "1393329818802482",
    "time_leave" : "1393329819239768",
    "track_points" : [
    {
       "h" : 8.25,
       "w" : 18.75,
       "x" : 41.5,
       "y" : 35.75
    },
    {
       "h" : 7.5,
       "w" : 17.25,
       "x" : 40,
       "y" : 37.25
    }
    ],
    "vehicle_type" : "car"
}
]
```

| Свойства | Значения | Описание свойства | Версия ПО |
|----------|----------|-------------------|------------|
| "h" |  | Высота распознанного номера | ≥3.1 |
| "w" |  | Ширина распознанного номера | ≥3.1 |
| "x" |  | Положение по горизонтальной оси левого верхнего угла распознанного номера в кадре | ≥3.1 |
| "y" |  | Положение по вертикальной оси левого верхнего угла распознанного номера в кадре | ≥3.1 |

### Подсказка

Значения параметров указываются в процентном отношении от размера кадра.

## Запрос событий ActivePOS

Пример запроса:

```
https://192.168.1.200:8080/pos_events?sid=zxRc8Y7w
```

Пример ответа сервера:

```
[
    {
        "event_timestamp": "1575472218724478",
        "flags": 0,
        "op_id" : "8262B3D2-DDE3-11E0-8E9D-0050FB005F2A",
        "pos_terminal" : "G7D1uymM",
        "pos_terminal_name" : "POS1",
        "position": "0",
        "price": 2750,
        "receipt_timestamp" : "1315903058000000",
        "quantity": 1,
        "type" : "POSNG_PAYMENT_CASH",
        "text" : "",
        "weight" : "0",
    },
    {
        "event_timestamp": "1575472220598461",
        "flags": 0,
        "op_id" : "8262B3D2-DDE3-11E0-8E9D-0050FB005F2A",
        "pos_terminal" : "G7D1uymM",
        "pos_terminal_name" : "POS1",
        "position" : "0",
        "price" : "40100",
        "receipt_timestamp" : "1315903058000000",
        "type" : "POSNG_RECEIPT_CHANGE",
        "text" : "",
        "quantity" : "0",
        "weight" : "0",

    },
    {
        "event_timestamp": "1575472227473028",
        "flags": 0,
        "op_id" : "8262B3D2-DDE3-11E0-8E9D-0050FB005F2A",
        "pos_terminal" : "G7D1uymM",
        "pos_terminal_name" : "POS1",
        "price" : "1250",
        "position" : "0",
        "quantity" : "0",
        "receipt_timestamp" : "1315903058000000",
        "type" : "POSNG_RECEIPT_NUMBER",
        "text" : "7768-50797",
        "weight" : "0",

    },
    {
        "event_timestamp": "1575472229976199",
        "flags": 0,
        "op_id" : "8262B3D2-DDE3-11E0-8E9D-0050FB005F2A",
        "pos_terminal" : "G7D1uymM",
        "pos_terminal_name" : "POS1",
        "position" : "0",
        "price" : "16660",
        "quantity" : "0",
        "receipt_timestamp" : "1315919540000000",
        "text" : "7768-50797",
        "type" : "POSNG_RECEIPT_OPEN",
        "weight" : "0",
    },
    {
        "event_timestamp": "1575472239973205",
        "flags": 0,
        "op_id" : "8262B3D2-DDE3-11E0-8E9D-0050FB005F2A",
        "pos_terminal" : "G7D1uymM",
        "pos_terminal_name" : "POS1",
        "position" : "1",
        "price" : "1887",
        "quantity" : "1",
        "receipt_timestamp" : "1315919540000000",
        "text" : "Oranges (1 kg price)",
        "type" : "POSNG_POSITION_ADD",
        "weight" : "572",
    }

]
```

| Свойства | Значения | Описание свойства | Версия ПО |
| --- | --- | --- | --- |
| "event_timestamp" |  | Время возникновения события | ≥3.2 |
| "flags" |  | Флаги | ≥3.2 |
| "op_id" |  | ID события ActivePOS | ≥3.2 |
| "pos_terminal" |  | GUID терминала | ≥3.2 |
| "pos_terminal_name" |  | Название терминала | ≥3.2 |
| "position" |  | Номер позиции | ≥3.2 |
| "price" |  | Цена товара | ≥3.2 |
| "quantity" |  | Количество товара | ≥3.2 |
| "receipt_timestamp" |  | Время создания документа | ≥3.2 |
| "text" |  | Текст | ≥3.2 |
| "type" |  | Тип события | ≥3.2 |
| "weight" |  | Вес товара | ≥3.2 |

### Подсказка

Время в ответе указывается в микросекундах в формате [UNIX-время](https://en.wikipedia.org/wiki/Unix_time) с учетом часового пояса, настроенного на сервере.

## Управление PTZ-камерой

Для управления PTZ-камерой необходимо получить к ней доступ.

Пример запроса:

```
https://192.168.1.200:8080/ptz?command=open&channel=FByNlKIq&sid=fjMlBJ0I
```

Ключевые элементы запроса:

- command=open - команда получения доступа к управлению PTZ-камерой;
- channel=[guid_канала] - guid канала PTZ-камеры;
- sid=[id_сессии] - id сессии, в которой выполняется запрос (см. пример [Получение id сессии](sdk-examples-id.html)).

Пример ответа сервера:

```
{
    "success" : "1",
}
```

Теперь, вы можете производить управление PTZ-камерой и ее настройку при помощи следующих запросов:

- Приблизить/удалить:

  ```
  https://192.168.1.200:8080/ptz?command=zoom&speed=1&sid=fjMlBJ0I
  ```

  где

  - speed=[значение] - скорость приближения/удаления (от -10 до 10).

- Сфокусироваться:

  ```
  https://192.168.1.200:8080/ptz?command=focus&speed=1&sid=fjMlBJ0I
  ```

  где

  - speed=[значение] - точка фокусировки от самой дальней (-10) до ближней (10).

- Включение функции автофокусировки:

  ```
  https://192.168.1.200:8080/ptz?command=autofocus&sid=fjMlBJ0I
  ```

- Настройка диафрагмы:

  ```
  https://192.168.1.200:8080/ptz?command=iris&speed=1&sid=fjMlBJ0I
  ```

  где

  - speed=[значение] - размер открытой диафрагмы (от -10 до 10).

- Включение функции автоматической регулировки диафрагмы:

  ```
  https://192.168.1.200:8080/ptz?command=autoiris&sid=fjMlBJ0I
  ```

- Поворот PTZ-камеры:

  ```
  https://192.168.1.200:8080/ptz?command=turn&speed_x=1&speed_y=-1&sid=fjMlBJ0I
  ```

  где

  - speed_x=[значение] - скорость поворота вокруг вертикальной оси (от -10 до 10).
  - speed_y=[значение] - скорость поворота вокруг горизонтальной оси (от -10 до 10).

- Поворот PTZ-камеры на заданные координаты:

  ```
  https://192.168.1.200:8080/ptz?command=position_set&speed_x=1&pan=0.0&tilt=0.0&zoom=0.0&sid=fjMlBJ0I
  ```

  где

  - pan=[значение] - угол поворота камеры.
  - tilt=[значение] - угол наклона камеры.
  - zoom=[значение] - степень приближения.

- Остановить поворот/приближение/удаление PTZ-камеры:

  ```
  https://192.168.1.200:8080/ptz?command=stop&sid=fjMlBJ0I
  ```

- Поворот PTZ-камеры на заданную предустановку:

  ```
  https://192.168.1.200:8080/ptz?&command=preset_goto&preset=1&sid=fjMlBJ0I
  ```

  где

  - preset=[значение] - номер предустановки.

- Сохранить положение камеры как предустановку:

  ```
  https://192.168.1.200:8080/ptz?&command=preset_save&preset=1&sid=fjMlBJ0I
  ```

  где

  - preset=[значение] - номер предустановки.

- Удалить предустановку камеры:

  ```
  https://192.168.1.200:8080/ptz?&command=preset_delete&preset=1&sid=fjMlBJ0I
  ```

  где

  - preset=[значение] - номер предустановки.

- Запустить функцию патрулирования:

  ```
  https://192.168.1.200:8080/ptz?&command=preset_patrol_start&preset=1&sid=fjMlBJ0I
  ```

  где

  - preset=[значение] - номер патрулирования.

- Команды управления OSD-меню PTZ-камеры:

  ```
  https://192.168.1.200:8080/ptz?&command=[команда]&sid=fjMlBJ0I
  ```

  где

  - command=menu_on - войти в OSD-меню;
  - command=menu_off - выйти из OSD-меню;
  - command=menu_up - стрелка вверх;
  - command=menu_down - стрелка вниз;
  - command=menu_left - стрелка влево;
  - command=menu_right - стрелка вправо;
  - command=menu_zoom_in - кнопка Z+;
  - command=menu_zoom_out - кнопка Z-;
  - command=menu_escape - кнопка ESC;
  - command=menu_enter - кнопка ENTER;

Для завершения работы с PTZ-камерой необходимо послать запрос:

```
https://192.168.1.200:8080/ptz?&command=close&sid=fjMlBJ0I
```

## Управление архивом

### Важно

Управление архивом возможно только после получение потока архива по следующему алгоритму:

0. Выполнить [запрос Token](sdk-examples-video.html#sdk-examples-video-token) с параметром stream=archive_main или stream=archive_sub.
1. По Token выполнить [запрос потока](sdk-examples-video.html#sdk-examples-video-stream).
2. С помощью команд управления архивом указать точку начала воспроизведения и запустить воспроизведение видео.

Примеры запросов:

* Включить воспроизведение фрагмента архива

  ```
  https://192.168.1.200:8080/archive_command?command=play&start=20180117T110734&stop=20180117T110834&speed=1&sid=e03qD0eg&token=P2FYkjcP
  ```

* Остановить воспроизведение архива

  ```
  https://192.168.1.200:8080/archive_command?command=stop&sid=e03qD0eg&token=P2FYkjcP
  ```

* Переместится на определенное время к ближайшему фрагменту архива

  ```
  https://192.168.1.200:8080/archive_command?command=seek&timestamp=20180117T110734&direction=0&sid=e03qD0eg&token=P2FYkjcP
  ```

* Переместится к следующему кадру фрагмента архива

  ```
  https://192.168.1.200:8080/archive_command?command=frame_next&sid=e03qD0eg&token=P2FYkjcP
  ```

* Переместится к предыдущему кадру фрагмента архива

  ```
  https://192.168.1.200:8080/archive_command?command=frame_prev&sid=e03qD0eg&token=P2FYkjcP
  ```

* Переместится к первому кадру фрагмента архива

  ```
  https://192.168.1.200:8080/archive_command?command=frame_first&sid=e03qD0eg&token=P2FYkjcP
  ```

* Переместится к последнему кадру фрагмента архива

  ```
  https://192.168.1.200:8080/archive_command?command=frame_last&sid=e03qD0eg&token=P2FYkjcP
  ```

Ключевые элементы запросов:

* command=[команда] - команда управления архивом:

  * stop - остановить воспроизведение архива;
  * play - включить воспроизведение архива;
  * seek - поиск по архиву;
  * next - перейти к следующему фрагменту архива;
  * prev - перейти к предыдущему фрагменту архива;
  * frame_first - перейти к первому кадру фрагмента архива;
  * frame_last - перейти к последнему кадру фрагмента архива;
  * frame_next - перейти к следующему кадру фрагмента архива;
  * frame_prev - перейти к предыдущему кадру фрагмента архива.
* start=[дата и время] и stop=[дата и время] - дата и время начала и конца проигрываемого фрагмента архива;
* speed=[число] - скорость воспроизведения архива (от 1 до 16);
* timestamp=[дата и время] - дата и время точки начала воспроизведения фрагмента архива;
* direction=[число] - направление поиска ближайшего кадра фрагмента архива:

  * 1 - искать ближайший кадр, расположенный впереди от даты timestamp ;
  * -1 - искать ближайший кадр, расположенный позади от даты timestamp ;
  * 0 - искать ближайший кадр в обоих направлениях от даты timestamp .
* sid=[id_сессии] - id сессии, в которой выполняется запрос (см. пример [Получение id сессии](sdk-examples-id.html));
* token=[Token] - уникальный Token видео (см. пример [Получение видео и аудиопотоков](sdk-examples-video.html)).

### Подсказка

Для указания даты и времени, данные в запросе должны быть представлены в одном из предложенных форматов:

* YYYY-MM-DD HH:MM:SS
* YYYY-MM-DDTHH:MM:SS
* YYYYMMDD-HHMMSS
* YYYYMMDDTHHMMSS
* а так же в UNIX(10 знаков) и TIMESTAMP(16 знаков) форматах.

Пример ответа сервера:

```
{
    "success" : "1",
}
```

## Запрос состояния архива

### Важно

Запрос состояния архива возможен только после получение потока архива по следующему алгоритму:

0. Выполнить [запрос Token](sdk-examples-video.html#sdk-examples-video-token) с параметром stream=archive_main или stream=archive_sub.
1. По Token выполнить [запрос потока](sdk-examples-video.html#sdk-examples-video-stream).
2. Выполнить команду запроса состояния архива.

Пример запроса состояния архива:

```
https://192.168.1.200:8080/archive_status?type=[тип_состояния]&sid=sid=[id_сессии]
```

Ключевые элементы запроса:

* type=[тип_состояния] - тип запрашиваемого состояния:

  - state - текущее состояния архива;
  - calendar - календарь архива;
  - timeline - шкала времени архива.
* sid=[id_сессии] - id сессии, в которой выполняется запрос (см. пример [Получение id сессии](sdk-examples-id.html) ).

Пример запроса текущего состояния архива:

```
https://192.168.1.200:8080/archive_status?type=state&sid=e03qD0eg
```

Пример ответа сервера:

```
[
    {
        "token" : "iWlB1MlD",
        "time" : "2014-02-24 14:17:00",
        "speed" : "0.000000",
        "state" : "1",
        "state_desc" : "",
        "state_time" : "1393237022489381"
    }
]
```

В данном примере ответ содержит:

* "token" : "iWlB1MlD" - уникальный Token для получения видео архива (см. пример [Получение видео и аудиопотоков](sdk-examples-video.html) );
* "time" : "2014-02-24 14:17:00" - дата и время проигрываемого архива;
* "speed" : "0.000000" - текущая скорость воспроизведения архива;
* "state" : "1" - текущее состояние архива:

  - 1 - воспроизведение архива остановлено;
  - 2 - архив воспроизводится;
  - 4 - поиск в архиве;
  - 8 - произошла ошибка;
  - 10 - диски заняты.
* "state_desc" : "" - описание состояния проигрываемого архива;
* "state_time" : "1393237022489381" - время изменения состояния архива в формате.

Пример запроса календаря архива:

```
https://192.168.1.200:8080/archive_status?type=calendar&sid=e03qD0eg
```

Пример ответа сервера:

```
[
    {
        "token" : "iWlB1MlD",
        "calendar" : [
            "2014-02-20",
            "2014-02-21",
            "2014-02-24"
            ]
    }
]
```

В данном примере ответ содержит:

* "token" : "iWlB1MlD" - уникальный Token для получения видео архива (см. пример [Получение видео и аудиопотоков](sdk-examples-video.html) );
* "calendar" : [] - список дат, для которых есть архив.

  ### Подсказка

  В "calendar" : [] содержится список дат соответствующих данному Token, а не по всем каналам сервера.

Пример запроса шкалы времени архива:

```
https://192.168.1.200:8080/archive_status?type=timeline&sid=e03qD0eg
```

Пример ответа сервера:

```
[
    {
        "token" : "iWlB1MlD",
        "day_start" : "2014-02-24",
        "timeline" : [
            {
                "begin" : "43090",
                "end" : "43094"
            },
            {
                "begin" : "43149",
                "end" : "44506"
            },
            {
                "begin" : "44592",
                "end" : "44844"
            },
            {
                "begin" : "45201",
                "end" : "50573"
            },
            {
                "begin" : "50628",
                "end" : "50628"
            },
            {
                "begin" : "51088",
                "end" : "51327"
            }
        ]
    }
]
```

В данном примере ответ содержит:

* "token" : "iWlB1MlD" - уникальный Token для получения видео архива (см. пример [Получение видео и аудиопотоков](sdk-examples-video.html) );
* "day_start" : "2014-02-24" - дата проигрываемого архива;
* "timeline" : [] - список непрерывных фрагментов архива, где:

  * "begin" : "" - время начала фрагмента архива;
  * "end" : "" - время конца фрагмента архива.

  ### Подсказка

  Время начала и конца фрагмента архива указывается в секундах от начала дня, в диапазоне от 0 до 86400.

## Запрос событий архива

### Важно

Запрос событий архива возможен только после получение потока архива по следующему алгоритму:

0. Выполнить [запрос Token](sdk-examples-video.html#sdk-examples-video-token) с параметром stream=archive_main или stream=archive_sub.
1. По Token выполнить [запрос потока](sdk-examples-video.html#sdk-examples-video-stream).
2. Выполнить команду запроса событий архива.

Пример запроса событий архива:

```
https://192.168.1.200:8080/archive_events?token=isaoPJAb&sid=e03qD0eg
```

Ключевые элементы запроса:

Пример ответа сервера:

```
[
    {
        "event_name" : "CalendarEvent",
        "calendar" : [
            "2014-02-20",
            "2014-02-21",
            "2014-02-24"
        ]
    },
    {
        "event_name" : "SpeedEvent",
        "speed" : "0.000000"
    },
    {
        "event_name" : "SpeedLimitEvent",
        "speed_limit" : "0"
    },
    {
        "event_name" : "StateTransitionEvent",
        "state" : "1",
        "state_desc" : "",
        "state_time" : "2014-02-24 14:24:54"
    },
    {
        "event_name" : "TimeChangedEvent",
        "time" : "2014-02-24 14:24:53"
    },
    {
        "event_name" : "TimelineEvent",
        "day_start" : "2014-02-24",
        "timeline" : "00000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
        0E0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
        FFFFFFFFFF1F0000000000000000000000000000000000000000000000000000000000000000000000000000000
        000000000FEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
        FFF3F00000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    },
    {
        "event_name" : "ActivityLevelEvent",
        "day_start" : "2014-02-24",
        "activities" : "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
        FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
        FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
        FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0"
    }
]
```

В данном примере ответ содержит следующие события архива:

* "event_name" : "CalendarEvent"

  "calendar" : [] - список дат, для которых есть архив.

  ### Подсказка

  В "calendar" : [] содержится список дат соответствующих данному Token, а не по всем каналам сервера.
* "event_name" : "SpeedEvent"

  "speed" : "0.000000" - текущая скорость воспроизведения архива.
* "event_name" : "SpeedLimitEvent"

  "speed_limit" : "0" - максимально возможная скорость воспроизведения архива.
* "event_name" : "StateTransitionEvent"

  "state" : "1" - текущее состояние архива:

  * 1 - воспроизведение архива остановлено;
  * 2 - архив воспроизводится;
  * 4 - поиск в архиве;
  * 8 - произошла ошибка;
  * 10 - диски заняты.

  "state_desc" : "" - описание состояния.

  "state_time" : "2014-02-24 14:24:54" - время изменения состояния.
* "event_name" : "TimeChangedEvent"

  "time" : "2014-02-24 14:24:53" - время изменения состояния.
* "event_name" : "TimelineEvent"

  "day_start" : "2014-02-24" - дата проигрываемого архива.

  "timeline" : "" - последовательность чисел в шестнадцатеричной системе, где каждый бит соответствует одной секунде записи в этот день:

  * 0 - записи нет;
  * 1 - запись есть.
* "event_name" : "ActivityLevelEvent"

  "day_start" : "2014-02-24" - дата проигрываемого архива.

  "activities" : "" - последовательность чисел в шестнадцатеричной системе, где каждый бит содержит информацию о наличии или отсутствии движения на канале:

  * 0 - движения нет;
  * 1 - движение есть.

  ### Подсказка

  В отличие от события "event_name" : "TimelineEvent", в событии "event_name" : "ActivityLevelEvent" содержится информация только о тех секундах, для которых есть архив.

## Локальный экспорт архива

**Локальный экспорт архива**

Локальный экспорт архива запускает экспорт архива и сохраняет полученный файл в [папку, предназначенную для сохранения скриншотов](setup-local-server.html). Поддерживаются несколько методов локального экспорта архива:

* **Методы, выполняемые при помощи объекта интерфейс оператора**

  Примеры запросов без возможности гибкой настройки параметров экспорта:

  ```
  https://192.168.1.200:8080/objects/operatorgui_jmxwAqxm/archive_export?channel_name_or_guid=HsnnGa9B&start_time_YYYYMMDD_HHMMSS=2014-11-26 17:34:00&end_time_YYYYMMDD_HHMMSS=2014-11-26 17:35:00&filename=export.avi&archive_on_device=0&sid=e03qD0eg
  https://192.168.1.200:8080/objects/operatorgui_jmxwAqxm/archive_export_ss?channel_name_or_guid=HsnnGa9B&start_time_YYYYMMDD_HHMMSS=2014-11-26 17:34:00&end_time_YYYYMMDD_HHMMSS=2014-11-26 17:35:00&filename=export.avi&archive_on_device=0&sid=e03qD0eg
  ```

  Пример запроса с возможностью гибкой настройки параметров экспорта:

  ```
  https://192.168.1.200:8080/objects/operatorgui_jmxwAqxm/archive_export_ex?channel_name_or_guid=HsnnGa9B&start_time_YYYYMMDD_HHMMSS=2014-11-26 17:34:00&end_time_YYYYMMDD_HHMMSS=2014-11-26 17:35:00&filename=export.avi&sid=e03qD0eg&options={"is_hardware": 0, "video_codec": "MPEG4", "video_bitrate":3000}
  ```

  ### Важно

  Методы локального экспорта архива, выполненные при помощи объекта интерфейс оператора, не работают при следующих условиях:

  * метод запускается на "слепом" сервере с TRASSIR OS (с неактивным интерфейсом оператора);
  * метод запускается на сервере с Windows, где серверное приложение запущено в виде службы.

* **Метод, выполняемый при помощи объекта канал**

  Данный метод не зависит от доступности интерфейса оператора и может быть запущен на любом сервере.

  Пример запроса:

  ```
  https://192.168.1.200:8080/objects/CKq5LLiO/export_archive?start_time_YYYYMMDD_HHMMSS=2014-11-26 17:34:00&end_time_YYYYMMDD_HHMMSS=2014-11-26 17:35:00&filename=export.avi&sid=e03qD0eg&options={"is_hardware": 1}
  ```

**Ключевые элементы запросов:**

* `archive_export`, `archive_export_ss` — команды вызова экспорта архива основного или дополнительного потока;
* `archive_export_ex`, `[GUID_канала]/export_archive` — команды вызова настраиваемого экспорта архива любого потока;
* `operatorgui_[GUID_интерфейса]` — идентификатор интерфейса оператора;
* `channel_name_or_guid=[GUID_канала]` — идентификатор канала, с которого производится экспорт;
* `start_time_YYYYMMDD_HHMMSS=2014-11-26 17:34:00` — дата и время начала экспорта;
* `end_time_YYYYMMDD_HHMMSS=2014-11-26 17:35:00` — дата и время конца экспорта;
* `filename=[имя_файла.avi]` — имя файла;
* `archive_on_device=0` — выбор источника архива:
  - `0` — архив на сервере;
  - `1` — архив на устройстве.
* `options={[параметры]}` — набор параметров экспорта в формате JSON:

  - `"is_hardware"` — выбор источника архива:
    * `0` — архив на сервере (значение по умолчанию);
    * `1` — архив на устройстве.
  - `"want_ss"` — выбор потока:
    * `0` — основной поток (значение по умолчанию);
    * `1` — дополнительный поток.
  - `"video_codec"` — выбор видеокодека, в который будет закодирован файл экспорта:
    * `""` — без перекодирования (значение по умолчанию);
    * `"MPEG4"` — перекодировать в MPEG4;
    * `"WMV"` — перекодировать в WMV (в TRASSIR OS не поддерживается).
  - `"video_resolution"` — выбор разрешения видеопотока (если используется перекодирование):
    * `""` — исходное разрешение видеопотока (значение по умолчанию);
    * `"2560x1920"`, `"1920x1080"`, `"1600x1200"`, `"1280x1024"`, `"1280x960"`, `"1280x720"`, `"1024x768"`, `"800x600"`, `"720x576"`, `"704x576"`, `"640x480"`, `"352x288"`, `"320x240"`, `"176x144"` — варианты разрешений.
  - `"video_bitrate"` — выбор битрейта экспортируемого файла (если используется перекодирование):
    * `200`, `400`, `600`, `800`, `1000`, `2000`, `2500`, `3000`, `5000`, `7500`, `10000`, `16000` — варианты битрейта.
  - `"audio_codec"` — выбор аудиокодека, в который будет закодирован звук в файле экспорта:
    * `""` — без перекодирования (значение по умолчанию);
    * `"No audio"` — без звука;
    * `"PCM"` — перекодировать в PCM;
    * `"WMA"` — перекодировать в WMA (в TRASSIR OS не поддерживается).
  - `"audio_bitrate"` — выбор битрейта аудиопотока экспортируемого файла (если используется перекодирование в WMA):
    * `64`, `128` — варианты битрейта.
  - `"need_channel_name_watermark"` — впечатать имя канала на видео:
    * `0` — не впечатывать (значение по умолчанию);
    * `1` — впечатать.
  - `"need_timestamp_watermark"` — впечатать дату и время на видео:
    * `0` — не впечатывать (значение по умолчанию);
    * `1` — впечатать.
  - `"watermark_align"` — положение текста на видео:
    * `1` — верхний левый угол (значение по умолчанию);
    * `2` — верхний правый угол;
    * `3` — нижний левый угол;
    * `4` — нижний правый угол.
  - `"need_fliprotate"` — [поворот и отражение](setup-channel-rotate.html) видео:
    * `0` — не использовать (значение по умолчанию);
    * `1` — использовать.
  - `"watermark_need_figures"` — впечатать [фигуры или субтитры](operator-ipcamerasfolder-window.html) на видео:
    * `0` — не впечатывать (значение по умолчанию);
    * `1` — впечатать.
* `sid=[id_сессии]` — id сессии, в которой выполняется запрос (см. пример [Получение id сессии](sdk-examples-id.html)).

### Подсказка

Время указывается с учетом часового пояса, настроенного на сервере.

Пример ответа сервера:

```
{
    "success" : "1",
}
```

---

**Команды управления задачами локального экспорта**

**Запрос текущих задач локального экспорта**

Пример запроса:

```
https://192.168.1.200:8080/export_tasks?sid=e03qD0eg
```

Пример ответа сервера:

```
[{
	"additional_data" : "{\n\t\"extras\" : \n\t{\n\t\t\"bluring\" : false,\n\t\t\"class_detection\" : \"head\",\n\t\t\"need_research_detectors\" : false\n\t}\n}\n",
	"created_ts" : "1571922911615786",
	"export_finish_ts" : "0",
	"export_start_ts" : "1571922911615786",
	"filename" : "C:/VMS/Screenshots/TR-D8121WDIR2v2 1_20191024-132119--20191024-132727.avi",
	"fragments" :
	[
		{
			"channel" : "qK30lb5k_OsnJuSGv",
			"end_ts" : "1571911565998605",
			"filename" : "",
			"start_ts" : "1571911180998846"
		},
		{
			"channel" : "qK30lb5k_OsnJuSGv",
			"end_ts" : "1571912847980932",
			"filename" : "",
			"start_ts" : "1571912479981939"
		}
	],
	"id" : "uzbijs1A",
	"out_format" : 0,
	"postponed_until_ts" : "1571922910083000",
	"progress_percent" : "30",
	"state" : 1,
	"state_desc" : "in_progress"
}]
```

В данном примере ответ содержит:

- `"additional_data"` — набор параметров задачи локального экспорта;
- `"created_ts"` — время создания задачи локального экспорта;
- `"export_start_ts"` — время начала выполнения задачи локального экспорта;
- `"export_finish_ts"` — время завершения задачи локального экспорта;
- `"filename"` — путь и имя файла (если экспортируется несколько фрагментов);
- `"fragments"` — список экспортируемых фрагментов:
  * `"channel"` — уникальный идентификатор канала в формате `[GUID_канала]_[GUID_сервера]`;
  * `"start_ts"` — время начала экспортируемого фрагмента;
  * `"end_ts"` — время конца экспортируемого фрагмента;
  * `"filename"` — путь и имя файла фрагмента (если экспортируется один фрагмент);
- `"id"` — уникальный идентификатор задачи локального экспорта;
- `"out_format"` — формат файла экспорта (`0` — AVI, `1` — [TRAVI](operator-archive-travi.html));
- `"postponed_until_ts"` — время запланированного запуска задачи (если используется отложенный экспорт);
- `"progress_percent"` — процент завершения задачи;
- `"state"` — статус задачи:
  * `0` — задача в ожидании;
  * `1` — задача выполняется;
  * `2` — задача завершена.
- `"state_desc"` — описание статуса:
  * `"postponed"` — задача в ожидании;
  * `"in_progress"` — задача выполняется;
  * `"completed"` — задача завершена.

### Подсказка

Время указывается в микросекундах в формате [UNIX-время](https://en.wikipedia.org/wiki/Unix_time) с учетом часового пояса, настроенного на сервере.

**Запрос на удаление задачи локального экспорта**

Пример запроса:

```
https://192.168.1.200:8080/export_cancel?sid=e03qD0eg&task_id=uzbijs1A
```

Ключевые элементы запроса:

* `sid=[id_сессии]` — id сессии, в которой выполняется запрос (см. пример [Получение id сессии](sdk-examples-id.html));
* `task_id=[id_задачи]` — уникальный идентификатор задачи локального экспорта.

Пример ответа сервера:

```
{
    "success" : "1"
}
```

## Удаленный экспорт архива

В отличие от команды, описанной в разделе [Локальный экспорт архива](sdk-examples-archive-export.html) команда Удаленный экспорт архива позволяет запросить фрагмент архива с любого сервера и скачать его.

### Важно

При использовании команды Удаленный экспорт архива следует учитывать следущее:

* Задачи удаленного экспорта архива не отображаются на [главной панели](operator-controlpanel.html).
* Одновременно выполняется только одна задача удаленного экспорта архива. При этом новая задача удаленного экспорта архива будет выполнена только после того, как завершатся уже имеющиеся задачи локального экспорта архива. А новые задачи локального экспорта архива не начнут выполняться пока не завершится выполнение текущей задачи удаленного экспорта архива.
* Интервал времени, за который производится экспорт архива не должен превышать 30 минут.
* Экспортируемый файл сохраняется с расширением .mp4.

Удаленный экспорт архива выполняется следующим образом:

0. Запрос на создание задачи удаленного экспорта архива

  Пример запроса:

  ```
  https://192.168.1.200:8080/jit-export-create-task?sid=MdFYYrjy
  ```

  Запрос посылается методом POST, в теле которого в формате JSON должны содержаться следующие данные:

  ```
  {
  "resource_guid": "zwzmklKi",
  "start_ts": 1596552540000000,
  "end_ts":   1596552600000000,
  "is_hardware": 0,
  "prefer_substream": 0
  }
  ```

  где:

  * "resource_guid": "zwzmklKi" - GUID канала;
  * "start_ts": 1596552540000000 - время начала экспортируемого фрагмента архива;
  * "end_ts": 1596552600000000 - время конца экспортируемого фрагмента архива;
  * "is_hardware": 0 - источник архива (0 - архив на сервере, 1 - архив на устройстве);
  * "prefer_substream": 0 - поток архива (0 - основной поток, 1 - дополнительный поток).

  ### Подсказка

  Время указывается в микросекундах в формате [UNIX-время](https://en.wikipedia.org/wiki/Unix_time) с учетом часового пояса, настроенного на сервере.

  Пример ответа сервера:

  ```
  {
  "success" : "1",
  "task_id" : "JgZN323E"
  }
  ```

  В данном примере ответ содержит:

  - "success" : "1" - сообщение об успешности выполнения запроса;
  - "task_id" : "JgZN323E" - уникальный id задачи.

  Если в теле запроса указан интервал длительностью более 30 минут или в указанном интервале отсутствует архив, то сервер ответит сообщением об ошибке:

  ```
  {
  "success" : "0",
  "error_code": "bad interval"
  }
  ```

1. Запрос для получения файла экспорта

  ### Подсказка

  Запрос на получение файла экспорта должен быть выполнен в течение 10 секунд после выполнения запроса на создание задачи. По истечении 10 секунд задача удаленного экспорта будет удалена.

  Пример запроса:

  ```
  https://192.168.1.200:8080/jit-export-download?sid=MdFYYrjy&task_id=JgZN323E
  ```

  Запрос посылается методом GET, в параметрах которого указываются следующие данные:

  - sid=MdFYYrjy - уникальный id сессии;
  - task_id=JgZN323E - id задачи, созданной ранее.

  В ответ сервер пришлет экспортируемый файл.

2. Запрос состояния задачи

  Пример запроса:

  ```
  https://192.168.1.200:8080/jit-export-task-status?sid=MdFYYrjy
  ```

  Запрос посылается методом POST, в теле которого в формате JSON должны содержаться следующие данные:

  ```
  {
  "task_id": "JgZN323E"
  }
  ```

  где:

  - "task_id": "JgZN323E" - id задачи, созданной ранее.

  Пример ответа сервера:

  ```
  {
  "active" : true,
  "done" : false,
  "progress" : 3,
  "sended" : 30456,
  "success" : 1
  }
  ```

  В данном примере ответ содержит:

  - "active" : true - состояние задачи (true - задача обрабатывается, false - задача не обрабатывается);
  - "done" : false - индикатор завершения задачи на сервере (true - задача успешно завершена, false - задача не завершена);
  - "progress" : 3 - процент завершения задачи, от 0 до 100;
  - "sended" : 30456 - количество байт видео, отосланных сервером;
  - "success" : 1 - сообщение об успешности выполнения запроса.

3. Запрос на удаление задачи удаленного экспорта

  Пример запроса:

  ```
  https://192.168.1.200:8080/jit-export-cancel-task?sid=MdFYYrjy&task_id=JgZN323E
  ```

  Запрос посылается методом GET, в параметрах которого указываются следующие данные:

  * sid=MdFYYrjy - уникальный id сессии;
  * task_id=JgZN323E - id удаляемой задачи.

  Пример ответа сервера:

  ```
  {
  "success" : "1"
  }
  ```

## Примеры использования SDK на языке Python

Примеры на этой странице используют Python, как самый простой язык программирования. В отличие от примеров, описанных в "Руководстве администратора", эти примеры нужно запускать как отдельную программу. Для запуска требуется установить Python.

Хотя SDK предназначен для использования в программах, все функции работают из браузера. Более того, в комментариях SDK подсказывает какие еще функции можно вызвать, вам остается только скопировать пример в строку адреса. Испытывайте все функции с помощью браузера!

Функции SDK требуют пароль к SDK или идентификатор сессии. В примерах заменяйте "123" на ваш пароль.

/login позволяет получить идентификатор сессии, зная пароль. Для большинства функций SDK не имеет значения, передан идентификатор сессии или сразу пароль. Только функции получения событий меняют свое поведение: при наличии пароля отдают все последние события, а при наличии идентификатора сессии только новые события.

/objects позволяет получить дерево объектов, найти объекты внутри сервера, например все каналы.

```
import urllib, re, ssl
s = urllib.urlopen("https://127.0.0.1:8080/objects/?password=12345", context=ssl._create_unverified_context()).read()
for x in s.replace("\n", "").split("{"):
    m = re.search('"name"\s*\:\s*"(.*?)".*Channel', x)
    if not m: continue
    print m.group(1)
```

Пример убирает из прочитанной строки все символы перевода строки "\n", разбивает результат на список строк по разделителю "{", в каждой строке из списка ищет "name" : "ИМЯ" ... Channel с помощью регулярного выражения. Если вхождение нашлось, печатает ИМЯ.

/objects/идентификатор.объекта позволяет просмотреть состояние объекта. Возможные состояния объекта можно посмотреть в редакторе правил, а также в описании класса.

/objects/идентификатор.объекта/метод?param1=val1&param2=val2 Позволяет вызвать метод объекта. Идентификатор объекта можно найти в дереве объектов. Имена методов, параметры можно найти в редакторе правил или в описании класса.

/classes/идентификатор.класса позволяет просмотреть возможные состояния объектов данного класса, а также доступные методы, включая типы и имена параметров.

/settings/папка/поле позволяет читать и писать настройки. Настройки в сервере разбиты по папкам, в которых есть поля одного из трех типов: integer, real, string. Имена папок, полей можно посмотреть, нажав F4 в интерфейсе администратора. Такой режим позволяет просматривать и редактировать настройки в обход диалогов. Этот режим позволяет поэкспериментировать, как ведет себя система при тех или иных изменениях в настройках.

Если имя поля в запросе не указано, SDK вернет список доступных полей и подпапок.

/events позволяет получать системные события. В ответе "timestamp" использует [UNIX-время](https://en.wikipedia.org/wiki/Unix_time) в микросекундах. Возможные типы событий можно посмотреть в редакторе правил. Поле "origin" содержит идентификатор объекта. Имя и другие свойства объекта можно получить из дерева объектов. В некоторых событиях содержаться дополнительные поля, например событие "Connected to %1 under %2" содержит два поля "server_address" и "under_username".

```
import urllib, re
s = urllib.urlopen("https://localhost:8080/login?password=123").read()
sid = re.search('"sid"\s*:\s*"(.*?)"', s).group(1)
print "my session: %s" % sid
while 1:
    s = urllib.urlopen("https://127.0.0.1:8085/events?sid=%s" % sid).read()
    print s
```

Пример получает и распечатывает события по мере того как они приходят.

/pos_events аналогично позволяет получать события POS. Формат события полностью аналогичен событию ActivePOS в скриптах.

/lpr_events аналогично позволяет получать события AutoTRASSIR. Формат события полностью аналогичен событию AutoTRASSIR в скриптах.