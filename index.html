<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRASSIR - –í–∏–¥–µ–æ</title>
  
  <!-- JSMpeg –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è MPEG-TS –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ -->
  <script>
    window.__loadLocalJSMpeg = function(reason) {
      if (window.__jsmpegFallbackRequested) return;
      window.__jsmpegFallbackRequested = true;
      console.warn('‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ JSMpeg —Å CDN –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π fallback.', reason || '');
      var script = document.createElement('script');
      script.src = '/node_modules/jsmpeg/jsmpg.js';
      script.onload = function() {
        window.__jsmpegLoadedFrom = 'local';
        console.log('‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è JSMpeg –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      };
      script.onerror = function(err) {
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å JSMpeg –Ω–∏ —Å CDN, –Ω–∏ –ª–æ–∫–∞–ª—å–Ω–æ', err);
      };
      document.head.appendChild(script);
    };
  </script>
  <script src="https://cdn.jsdelivr.net/gh/phoboslab/jsmpeg@master/jsmpeg.min.js"
          onload="window.__jsmpegLoadedFrom='cdn';"
          onerror="window.__loadLocalJSMpeg && window.__loadLocalJSMpeg(event);"></script>
  <script>
    if (typeof JSMpeg === 'undefined') {
      window.addEventListener('load', function() {
        if (typeof JSMpeg === 'undefined' && !window.__jsmpegLoadedFrom) {
          window.__loadLocalJSMpeg && window.__loadLocalJSMpeg('JSMpeg –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
        }
      });
    }
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #4a9eff;
    }
    select {
      padding: 10px;
      margin: 5px;
      background: #1a1a1a;
      border: 1px solid #555;
      border-radius: 4px;
      color: #e0e0e0;
      font-size: 14px;
    }
    canvas {
      background: #000;
      border: 2px solid #555;
      border-radius: 4px;
      max-width: 100%;
      display: block;
      margin: 10px auto;
    }
    .live-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .video-wrapper {
      flex: 1;
      min-width: 320px;
    }
    .error {
      background: #d32f2f;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>TRASSIR - –í–∏–¥–µ–æ</h1>
    
    <select id="cameraSelect">
      <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>
    </select>
    
    <div class="live-layout">
      <div class="video-wrapper">
        <canvas id="videoCanvas" width="640" height="360"></canvas>
        <div id="videoStatus"></div>
      </div>
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let ws = null;
    let currentCameraGuid = null;
    let jsmpegPlayer = null;

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞
    function stopVideoPlayer() {
      if (jsmpegPlayer && typeof jsmpegPlayer.destroy === 'function') {
        try {
          jsmpegPlayer.destroy();
        } catch (error) {
          console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ JSMpeg:', error);
        }
      }
      jsmpegPlayer = null;
    }

    // –ó–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞
    function startVideoPlayer(streamInfo) {
      const canvas = document.getElementById('videoCanvas');
      const status = document.getElementById('videoStatus');

      const JSMpegLib = typeof JSMpeg !== 'undefined' ? JSMpeg : (typeof window.JSMpeg !== 'undefined' ? window.JSMpeg : null);
      if (!JSMpegLib || typeof JSMpegLib.Player !== 'function') {
        console.error('‚ùå JSMpeg.Player –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        stopVideoPlayer();
        status.textContent = '–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (JSMpeg –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω)';
        status.className = 'error';
        return;
      }

      stopVideoPlayer();

      const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
      const hostname = window.location.hostname;
      const portPart = streamInfo.wsPort !== undefined && streamInfo.wsPort !== null
        ? `:${streamInfo.wsPort}`
        : (window.location.port ? `:${window.location.port}` : '');
      const videoUrl = `${protocol}://${hostname}${portPart}/?streamId=${encodeURIComponent(streamInfo.streamId)}`;

      const baseOptions = {
        canvas,
        audio: false,
        autoplay: true,
        streaming: true
      };

      try {
        jsmpegPlayer = new JSMpegLib.Player(videoUrl, baseOptions);
        status.textContent = '–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
        status.className = '';
        console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JSMpeg –∫', videoUrl);
      } catch (error) {
        const needCanvasFallback = /webgl/i.test(error?.message || '') || /WebGLRenderer/i.test(error?.stack || '');
        if (needCanvasFallback) {
          console.warn('‚ö†Ô∏è WebGL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º Canvas renderer');
          try {
            if (JSMpegLib?.Renderer?.WebGL) {
              JSMpegLib.Renderer.WebGL.IsSupported = () => false;
            }
            jsmpegPlayer = new JSMpegLib.Player(videoUrl, { ...baseOptions, disableGl: true });
            status.textContent = '–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω (Canvas)';
            status.className = '';
            return;
          } catch (fallbackError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ Canvas renderer:', fallbackError);
          }
        } else {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ JSMpeg Player:', error);
        }

        stopVideoPlayer();
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫';
        status.className = 'error';
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
    function initVideoWebSocket() {
      if (ws) ws.close();
      
      const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
      const wsHost = window.TRASSIR_WS_HOST || window.location.hostname || '192.168.1.12';
      const wsPort = window.TRASSIR_WS_PORT ?? 8080;
      const wsPortSuffix = wsPort ? `:${wsPort}` : '';
      ws = new WebSocket(`${wsProtocol}://${wsHost}${wsPortSuffix}`);
      ws.binaryType = 'arraybuffer';
      
      const status = document.getElementById('videoStatus');
      
      ws.onopen = () => {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        status.className = '';
        if (currentCameraGuid) {
          try {
            ws.send(JSON.stringify({ guid: currentCameraGuid }));
          } catch (error) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫:', error);
          }
        }
      };

      ws.onmessage = event => {
        const status = document.getElementById('videoStatus');

        if (typeof event.data === 'string') {
          let data;
          try {
            data = JSON.parse(event.data);
          } catch (error) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ WebSocket:', error);
            return;
          }

          // –°–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
          if (data.type === 'cameras' && Array.isArray(data.data)) {
            const cameras = data.data;
            const select = document.getElementById('cameraSelect');
            const options = cameras.map(c => `<option value="${c.guid}">${c.name || c.guid}</option>`).join('');
            select.innerHTML = cameras.length ? options : '<option value="">–ù–µ—Ç –∫–∞–º–µ—Ä</option>';
            
            if (cameras.length > 0 && !currentCameraGuid) {
              select.value = cameras[0].guid;
              select.dispatchEvent(new Event('change'));
            }
            return;
          }

          // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Ç–æ–∫–µ
          if (data.type === 'stream' && data.mode === 'video' && data.streamId) {
            startVideoPlayer(data);
            return;
          }

          // –û—à–∏–±–∫–∏
          if (data.error) {
            const message = data.error || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            status.textContent = '–û—à–∏–±–∫–∞: ' + message;
            status.className = 'error';
            return;
          }
        }
      };
      
      ws.onerror = () => {
        stopVideoPlayer();
        status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
        status.className = 'error';
      };
      
      ws.onclose = () => {
        stopVideoPlayer();
        status.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ';
        status.className = 'error';
      };
    }

    // –í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã
    document.getElementById('cameraSelect').addEventListener('change', function() {
      const guid = this.value || null;
      currentCameraGuid = guid;

      stopVideoPlayer();

      const canvas = document.getElementById('videoCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const status = document.getElementById('videoStatus');

      if (guid) {
        status.textContent = (ws && ws.readyState === WebSocket.OPEN)
          ? '–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã...'
          : '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket...';
        status.className = '';

        if (ws && ws.readyState === WebSocket.OPEN) {
          console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É:', guid);
          try {
            ws.send(JSON.stringify({ guid }));
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã:', error);
            status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É';
            status.className = 'error';
          }
        }
      } else {
        status.textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
        status.className = 'error';
        if (ws && ws.readyState === WebSocket.OPEN) {
          try {
            ws.send(JSON.stringify({ type: 'stop' }));
          } catch (error) {
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫–∞:', error);
          }
        }
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
      initVideoWebSocket();
    });
  </script>
</body>
</html>


