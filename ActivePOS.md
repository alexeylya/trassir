# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TRASSIR ActivePOS –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥

–≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è TRASSIR ActivePOS –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π Node.js –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º TRASSIR —á–µ—Ä–µ–∑ REST API, WebSocket –∏ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∏. ActivePOS –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∫–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (POS-—Å–æ–±—ã—Ç–∏—è), —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞–º–∏, –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞. –í –∫–æ–¥–µ —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ActivePOS —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `getActivePosEvents` –∏ WebSocket-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `subscribe-pos-events`. –ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω—ã —à–∞–≥–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, —É–ª—É—á—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.

---

## –¶–µ–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ POS-—Å–æ–±—ã—Ç–∏–π**: –ü–æ–ª—É—á–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –æ—Ç ActivePOS (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –æ–ø–ª–∞—Ç–∞) —á–µ—Ä–µ–∑ TRASSIR SDK.
2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≤–∏–¥–µ–æ**: –°–≤—è–∑–∞—Ç—å POS-—Å–æ–±—ã—Ç–∏—è —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –≤–∏–¥–µ–æ).
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å POS-—Å–æ–±—ã—Ç–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ WebSocket.
4. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**: –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π, –ø–æ–∏—Å–∫ —á–µ–∫–æ–≤ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –æ—Ç—á–µ—Ç–∞–º–∏ ActivePOS.
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –û–±–µ—Å–ø–µ—á–∏—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å—Ç–µ—á–µ–Ω–∏–µ SID, —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏).

---

## –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ActivePOS –≤ –∫–æ–¥–µ
–ö–æ–¥ —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç –±–∞–∑–æ–≤—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É ActivePOS:
- **–ú–µ—Ç–æ–¥ `TrassirClient.getActivePosEvents`**:
  - –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ `/pos_events` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–æ–ø–∏—Å–∞–Ω –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ ActivePOS).
- **REST API**:
  - –≠–Ω–¥–ø–æ–∏–Ω—Ç `/api/pos-events` –≤—ã–∑—ã–≤–∞–µ—Ç `getActivePosEvents` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π.
- **WebSocket**:
  - –ö–æ–º–∞–Ω–¥–∞ `subscribe-pos-events` –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å `/pos_events` —á–µ—Ä–µ–∑ `startPosEventsStream`.
  - –°–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ WebSocket —Å —Ç–∏–ø–æ–º `pos-events`.
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (`params`) –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ (`pollInterval`).
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
  - –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `POS_EVENTS_POLL_INTERVAL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000 –º—Å) –∑–∞–¥–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞.

–û–¥–Ω–∞–∫–æ —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ POS-—Å–æ–±—ã—Ç–∏–π —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞–º–∏.
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª—É –∏–ª–∏ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è).
- –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ –∏–ª–∏ –ø–æ–∏—Å–∫–∞ —á–µ–∫–æ–≤ —á–µ—Ä–µ–∑ ActivePOS.
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ SID –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞).

---

## –®–∞–≥–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ActivePOS

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ TRASSIR
–ü–µ—Ä–µ–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä TRASSIR –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ActivePOS:
- **–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏—è ActivePOS**: –õ–∏—Ü–µ–Ω–∑–∏—è ActivePOS-1/4 –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤.
- **–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Ç–µ—Ä–º–∏–Ω–∞–ª—ã**:
  - –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ TRASSIR –¥–æ–±–∞–≤–ª–µ–Ω—ã POS-—Ç–µ—Ä–º–∏–Ω–∞–ª—ã (—Ä–∞–∑–¥–µ–ª **ActivePOS** > **–¢–µ—Ä–º–∏–Ω–∞–ª—ã**).
  - –£–∫–∞–∑–∞–Ω—ã IP-–∞–¥—Ä–µ—Å–∞ –∏ –ø–æ—Ä—Ç—ã (–æ–±—ã—á–Ω–æ 2555 –¥–ª—è Moxa).
  - –ü—Ä–∏–≤—è–∑–∞–Ω—ã –∫–∞–Ω–∞–ª—ã –∫–∞–º–µ—Ä –∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞–º.
- **–í–∫–ª—é—á–µ–Ω—ã —Ñ–ª–∞–≥–∏**:
  - –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω—ã `MJPEG`, `FLV`, `RTSP` –¥–ª—è –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–≤.
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (`prisma`) –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ POS-—Å–æ–±—ã—Ç–∏—è–º –∏ –≤–∏–¥–µ–æ.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å POS-—Å–∏—Å—Ç–µ–º–æ–π**:
  - –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç POS-—Å–∏—Å—Ç–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, R-Keeper, 1C) –≤ —Ñ–æ—Ä–º–∞—Ç–µ DSSL XML —á–µ—Ä–µ–∑ TCP/UDP.
  - –î–ª—è R-Keeper –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ñ–∞–π–ª `pos-rkeeper.ini` —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ —Å–æ–±—ã—Ç–∏–π.
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π**:
  - –í TRASSIR (—Ä–∞–∑–¥–µ–ª **–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π**) —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ POS-—Å–æ–±—ã—Ç–∏—è –ø–æ—Å—Ç—É–ø–∞—é—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, `POSNG_RECEIPT_OPEN`, `POSNG_PAYMENT_CASH`).

**–î–µ–π—Å—Ç–≤–∏—è**:
1. –í–æ–π–¥–∏—Ç–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å TRASSIR (`https://192.168.109.181:8080`).
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –∏ —Ñ–ª–∞–≥–∏.
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–∫—Ä—ã—Ç–∏–µ —á–µ–∫–∞) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π.
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `prisma` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ `/pos_events` –∏ `/get_video`.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–±—ã—Ç–∏–π**:
```bash
curl "https://192.168.109.181:8080/pos_events?sid=<SID>"
```

---

### 2. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ `TrassirClient` –¥–ª—è ActivePOS
–î–æ–±–∞–≤–∏–º –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ActivePOS, –≤–∫–ª—é—á–∞—è –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π –∏ –ø–æ–∏—Å–∫ —á–µ–∫–æ–≤.

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `TrassirClient`**:
–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –≤ –∫–ª–∞—Å—Å `TrassirClient`:

```javascript
// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
async getPosTerminals() {
  try {
    const response = await this.sdkRequest({
      endpoint: '/objects',
      sidType: 'user'
    });
    const terminals = response.filter(obj => obj?.class === 'PosTerminal');
    return terminals.map(terminal => ({
      guid: terminal.guid,
      name: terminal.name || terminal.guid,
      ip: terminal.ip,
      port: terminal.port,
      channel: terminal.channel // GUID –∫–∞–º–µ—Ä—ã, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º
    }));
  } catch (error) {
    throw createError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤', error);
  }
}

// –ü–æ–∏—Å–∫ —á–µ–∫–æ–≤ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
async searchPosReceipts(params = {}) {
  return this.sdkRequest({
    endpoint: '/pos_receipts',
    params: { ...params, format: 'json' },
    sidType: 'user'
  });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ ActivePOS
async getPosReport(params = {}) {
  return this.sdkRequest({
    endpoint: '/pos_report',
    params: { ...params, format: 'json' },
    sidType: 'user'
  });
}
```

**–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤**:
- `getPosTerminals`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ —Å –∏—Ö GUID, –∏–º–µ–Ω–µ–º, IP, –ø–æ—Ä—Ç–æ–º –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º –∫–∞–º–µ—Ä—ã.
- `searchPosReceipts`: –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å —á–µ–∫–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–∞—Ç–∞, —Ç–µ—Ä–º–∏–Ω–∞–ª, —Å—É–º–º–∞). –≠–Ω–¥–ø–æ–∏–Ω—Ç `/pos_receipts` –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω, —É—Ç–æ—á–Ω–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ TRASSIR.
- `getPosReport`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —á–µ–∫–∞–º –∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–∫–æ–≤, –Ω–∞—Ä—É—à–µ–Ω–∏—è).

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```javascript
const terminals = await trassir.getPosTerminals();
console.log('POS-—Ç–µ—Ä–º–∏–Ω–∞–ª—ã:', terminals);

const receipts = await trassir.searchPosReceipts({
  terminal: 'G7D1uymM',
  start_time: '1575472239000000',
  end_time: '1575472240000000'
});
console.log('–ß–µ–∫–∏:', receipts);

const report = await trassir.getPosReport({
  terminal: 'G7D1uymM',
  type: 'incidents',
  start_date: '2025-11-01',
  end_date: '2025-11-12'
});
console.log('–û—Ç—á–µ—Ç:', report);
```

---

### 3. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ POS-—Å–æ–±—ã—Ç–∏–π
–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `startPosEventsStream` –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç `/pos_events` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ WebSocket. –£–ª—É—á—à–∏–º –µ–µ:
- –î–æ–±–∞–≤–∏–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏–π –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–ª—É, —Ç–∏–ø—É –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏.
- –°–æ—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π `event_timestamp` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.
- –î–æ–±–∞–≤–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ –≤–º–µ—Å—Ç–µ —Å —Å–æ–±—ã—Ç–∏–µ–º).

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `startPosEventsStream`**:
–ó–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `startPosEventsStream` –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é:

```javascript
async function startPosEventsStream(ws, params = {}) {
  stopPosEventsStream(ws);

  const state = {
    cancelled: false,
    pending: false,
    timer: null,
    lastLogAt: 0,
    lastEventTimestamp: params.lastEventTimestamp || 0 // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π timestamp
  };

  posEventStreams.set(ws, state);

  const rawInterval = Number(params.pollInterval);
  const pollIntervalBase = Number.isFinite(rawInterval) && rawInterval >= 0
    ? rawInterval
    : POS_EVENTS_POLL_INTERVAL_MS;
  const pollInterval = Math.max(pollIntervalBase, 100);
  const requestParams = { ...params };
  delete requestParams.pollInterval;
  delete requestParams.lastEventTimestamp;

  console.log('üßæ ActivePOS: –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞', {
    ...requestParams,
    pollInterval
  });

  const poll = async () => {
    if (state.cancelled || ws.readyState !== WebSocket.OPEN) {
      return;
    }

    if (state.pending) {
      state.timer = setTimeout(poll, pollInterval);
      return;
    }

    state.pending = true;
    try {
      const response = await trassir.getActivePosEvents(requestParams);
      let events = Array.isArray(response) ? response : Array.isArray(response?.data) ? response.data : [];

      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è)
      events = events.filter(event => {
        if (!event.event_timestamp) return true;
        const timestamp = Number(event.event_timestamp);
        return timestamp > state.lastEventTimestamp;
      });

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
      events.sort((a, b) => Number(a.event_timestamp || 0) - Number(b.event_timestamp || 0));

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–º
      const enrichedEvents = await Promise.all(events.map(async event => {
        if (event.pos_terminal && videoStreamsByGuid.has(event.pos_terminal)) {
          const videoStream = videoStreamsByGuid.get(event.pos_terminal);
          return {
            ...event,
            video: {
              streamId: videoStream.id,
              wsPort: VIDEO_WS_PORT,
              container: videoStream.container,
              timestamp: event.event_timestamp
            }
          };
        }
        return event;
      }));

      if (enrichedEvents.length && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'pos-events',
          data: enrichedEvents
        }));

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π timestamp
        const lastEvent = enrichedEvents[enrichedEvents.length - 1];
        if (lastEvent?.event_timestamp) {
          state.lastEventTimestamp = Number(lastEvent.event_timestamp);
        }
      }

      const now = Date.now();
      const shouldLog =
        enrichedEvents.length > 0 ||
        now - state.lastLogAt >= Math.max(pollInterval * 10, 10_000);
      if (shouldLog) {
        state.lastLogAt = now;
        console.log('üßæ ActivePOS: –æ—Ç–≤–µ—Ç', {
          channel: requestParams.channel,
          events: enrichedEvents.length,
          lastEventTimestamp: state.lastEventTimestamp,
          pollInterval
        });
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è POS —Å–æ–±—ã—Ç–∏–π:', error.message);
      if (trassir.isInvalidSidError(error)) {
        trassir.invalidateSid('user');
      }
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'error',
          message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è ActivePOS',
          details: error.message
        }));
      }
    } finally {
      state.pending = false;
      if (!state.cancelled) {
        state.timer = setTimeout(poll, pollInterval);
      }
    }
  };

  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'stream',
      mode: 'pos-events',
      params: requestParams,
      lastEventTimestamp: state.lastEventTimestamp
    }));
  }

  poll();
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π**: –°–æ–±—ã—Ç–∏—è —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ `event_timestamp`, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≤–∏–¥–µ–æ**: –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (`pos_terminal`). –ï—Å–ª–∏ –¥–∞, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ (`streamId`, `wsPort`, `container`).
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ SID**: –ü—Ä–∏ –æ—à–∏–±–∫–µ `Invalid SID` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `invalidateSid` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SID.
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–±—ã—Ç–∏–π –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–º `event_timestamp`.

**–ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**:
```javascript
ws.send(JSON.stringify({
  type: 'subscribe-pos-events',
  params: {
    terminal: 'G7D1uymM', // GUID —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    type: 'POSNG_PAYMENT_CASH', // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
    pollInterval: 500, // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ –≤ –º—Å
    lastEventTimestamp: 1575472239973205 // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –¥–æ —ç—Ç–æ–≥–æ timestamp
  }
}));
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É**:
```json
{
  "type": "pos-events",
  "data": [
    {
      "event_timestamp": "1575472239973205",
      "op_id": "8262B3D2-DDE3-11E0-8E9D-0050FB005F2A",
      "pos_terminal": "G7D1uymM",
      "type": "POSNG_POSITION_ADD",
      "text": "Oranges (1 kg)",
      "video": {
        "streamId": "G7D1uymM-abc123",
        "wsPort": 8082,
        "container": "mjpeg",
        "timestamp": "1575472239973205"
      }
    }
  ]
}
```

---

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ REST API –¥–ª—è ActivePOS
–î–æ–±–∞–≤–∏–º —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤, –ø–æ–∏—Å–∫–∞ —á–µ–∫–æ–≤ –∏ –æ—Ç—á–µ—Ç–æ–≤.

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `app`**:
–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã –≤ –±–ª–æ–∫ REST API:

```javascript
// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
app.get('/api/pos-terminals', handleRoute(async () => {
  return trassir.getPosTerminals();
}));

// –ü–æ–∏—Å–∫ —á–µ–∫–æ–≤
app.get('/api/pos-receipts', handleRoute(async (req) => {
  return trassir.searchPosReceipts(req.query);
}));

// –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ ActivePOS
app.get('/api/pos-report', handleRoute(async (req) => {
  return trassir.getPosReport(req.query);
}));
```

**–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤**:
- –°–ø–∏—Å–æ–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤:
  ```bash
  curl "http://localhost:3000/api/pos-terminals"
  ```
  –û—Ç–≤–µ—Ç:
  ```json
  [
    {
      "guid": "G7D1uymM",
      "name": "POS1",
      "ip": "192.168.109.181",
      "port": 2555,
      "channel": "CTrQ1DnE"
    }
  ]
  ```

- –ü–æ–∏—Å–∫ —á–µ–∫–æ–≤:
  ```bash
  curl "http://localhost:3000/api/pos-receipts?terminal=G7D1uymM&start_time=1575472239000000&end_time=1575472240000000"
  ```

- –û—Ç—á–µ—Ç:
  ```bash
  curl "http://localhost:3000/api/pos-report?terminal=G7D1uymM&type=incidents&start_date=2025-11-01&end_date=2025-11-12"
  ```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã `/pos_receipts` –∏ `/pos_report` –º–æ–≥—É—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –≤ –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ TRASSIR. –£—Ç–æ—á–Ω–∏—Ç–µ –∏—Ö –Ω–∞–ª–∏—á–∏–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫—É DSSL.

---

### 5. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è POS-—Å–æ–±—ã—Ç–∏–π —Å –≤–∏–¥–µ–æ
–î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–º –¥–æ–±–∞–≤–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞, –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ POS-—Å–æ–±—ã—Ç–∏—è.

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `startPosEventsStream`**:
–î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ–ø—Ä–æ—Å–∞ —Å–æ–±—ã—Ç–∏–π:

```javascript
async function startPosEventsStream(ws, params = {}) {
  stopPosEventsStream(ws);

  const state = { /* ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ... */ };

  posEventStreams.set(ws, state);

  const rawInterval = Number(params.pollInterval);
  const pollIntervalBase = Number.isFinite(rawInterval) && rawInterval >= 0
    ? rawInterval
    : POS_EVENTS_POLL_INTERVAL_MS;
  const pollInterval = Math.max(pollIntervalBase, 100);
  const requestParams = { ...params };
  delete requestParams.pollInterval;
  delete requestParams.lastEventTimestamp;

  // –ó–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
  if (requestParams.terminal) {
    try {
      const terminals = await trassir.getPosTerminals();
      const terminal = terminals.find(t => t.guid === requestParams.terminal);
      if (terminal?.channel) {
        await startVideoStream(ws, terminal.channel);
        console.log(`üé• –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ${requestParams.terminal} (–∫–∞–º–µ—Ä–∞: ${terminal.channel})`);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:', error.message);
    }
  }

  console.log('üßæ ActivePOS: –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞', {
    ...requestParams,
    pollInterval
  });

  const poll = async () => {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
  };

  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'stream',
      mode: 'pos-events',
      params: requestParams,
      lastEventTimestamp: state.lastEventTimestamp
    }));
  }

  poll();
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –ï—Å–ª–∏ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —É–∫–∞–∑–∞–Ω `terminal`, –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ `getPosTerminals`.
- –ï—Å–ª–∏ —É —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –µ—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞ (`channel`), –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –¥–ª—è —ç—Ç–æ–π –∫–∞–º–µ—Ä—ã —á–µ—Ä–µ–∑ `startVideoStream`.
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ –∏–ª–∏ –æ—à–∏–±–∫–∞.

**–ü—Ä–∏–º–µ—Ä**:
–ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:
```javascript
ws.send(JSON.stringify({
  type: 'subscribe-pos-events',
  params: {
    terminal: 'G7D1uymM'
  }
}));
```
–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –¥–ª—è –∫–∞–º–µ—Ä—ã, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º `G7D1uymM`, –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å POS-—Å–æ–±—ã—Ç–∏—è.

---

### 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
–î–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å ActivePOS, –∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `TrassirClient`**:
–û–±–Ω–æ–≤–∏—Ç–µ –º–µ—Ç–æ–¥ `sdkRequest` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ ActivePOS:

```javascript
async sdkRequest(options, attempt = 0) {
  const {
    endpoint,
    method = 'GET',
    params = {},
    data,
    responseType = 'text',
    sidType = 'sdk',
    skipParse = false
  } = options;

  let mergedParams = { ...params };
  let sid = null;
  if (sidType) {
    sid = await this.ensureSid(sidType);
    mergedParams = { ...mergedParams, sid };
  }

  try {
    const response = await this.axios.request({
      url: endpoint,
      method,
      params: mergedParams,
      data,
      responseType
    });

    if (responseType === 'arraybuffer' || skipParse) {
      return response.data;
    }

    return tryParseJson(response.data);
  } catch (error) {
    if (sidType && this.isInvalidSidError(error) && attempt === 0) {
      this.invalidateSid(sidType);
      return this.sdkRequest(options, attempt + 1);
    }
    if (endpoint === '/pos_events' && error.response?.status === 503) {
      throw createError('–°–µ—Ä–≤–µ—Ä ActivePOS –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', error);
    }
    throw error;
  }
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ `503` (—Å–µ—Ä–≤–µ—Ä ActivePOS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω), –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ.
- –ü—Ä–∏ –æ—à–∏–±–∫–µ `Invalid SID` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è SID.

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `startPosEventsStream`**:
–î–æ–±–∞–≤—å—Ç–µ retry-–º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤:

```javascript
const poll = async () => {
  if (state.cancelled || ws.readyState !== WebSocket.OPEN) {
    return;
  }

  if (state.pending) {
    state.timer = setTimeout(poll, pollInterval);
    return;
  }

  state.pending = true;
  let retryCount = 0;
  const maxRetries = 3;

  const attemptPoll = async () => {
    try {
      const response = await trassir.getActivePosEvents(requestParams);
      let events = Array.isArray(response) ? response : Array.isArray(response?.data) ? response.data : [];
      // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π ...
    } catch (error) {
      if (error.message.includes('–°–µ—Ä–≤–µ—Ä ActivePOS –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω') && retryCount < maxRetries) {
        retryCount++;
        console.warn(`‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è POS —Å–æ–±—ã—Ç–∏–π (${retryCount}/${maxRetries})`);
        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
        return attemptPoll();
      }
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è POS —Å–æ–±—ã—Ç–∏–π:', error.message);
      if (trassir.isInvalidSidError(error)) {
        trassir.invalidateSid('user');
      }
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'error',
          message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è ActivePOS',
          details: error.message
        }));
      }
    }
  };

  await attemptPoll();
  state.pending = false;
  if (!state.cancelled) {
    state.timer = setTimeout(poll, pollInterval);
  }
};
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (–¥–æ 3 —Ä–∞–∑) –ø—Ä–∏ –æ—à–∏–±–∫–µ `503`.
- –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è (1, 2, 3 —Å–µ–∫—É–Ω–¥—ã).

---

### 7. –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
–î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ActivePOS –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) –¥–æ–ª–∂–Ω–∞:
- –ü–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ POS-—Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ WebSocket.
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–º.
- –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ø–∏—Å–æ–∫ —á–µ–∫–æ–≤, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö).

**–ü—Ä–∏–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞ (JavaScript)**:
```javascript
const ws = new WebSocket('ws://localhost:8080');

ws.onopen = () => {
  console.log('WebSocket connected');
  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ POS-—Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
  ws.send(JSON.stringify({
    type: 'subscribe-pos-events',
    params: {
      terminal: 'G7D1uymM',
      pollInterval: 500
    }
  }));
};

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  if (message.type === 'pos-events') {
    message.data.forEach(event => {
      console.log('POS Event:', event);
      if (event.video) {
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫—É
        const videoWs = new WebSocket(`ws://localhost:${event.video.wsPort}?streamId=${event.video.streamId}`);
        videoWs.onmessage = (videoData) => {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å mpegts.js)
          console.log('Video frame received');
        };
      }
    });
  } else if (message.type === 'stream' && message.mode === 'video') {
    // –ó–∞–ø—É—Å–∫ –ø–ª–µ–µ—Ä–∞ –¥–ª—è –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
    console.log('Video stream started:', message);
  } else if (message.type === 'error') {
    console.error('Error:', message.message);
  }
};

ws.onerror = (error) => console.error('WebSocket error:', error);
ws.onclose = () => console.log('WebSocket closed');
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `mpegts.js` –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞:
  ```javascript
  const player = mpegts.createPlayer({
    type: 'mpegts',
    url: `ws://localhost:${VIDEO_WS_PORT}?streamId=<streamId>`,
    isLive: true
  });
  player.attachMediaElement(document.getElementById('video'));
  player.load();
  player.play();
  ```
- –û—Ç–æ–±—Ä–∞–∂–∞–π—Ç–µ POS-—Å–æ–±—ã—Ç–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–±–ª–∏—Ü–∞ —á–µ–∫–æ–≤ —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: –≤—Ä–µ–º—è, —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è, —Å—É–º–º–∞, –≤–∏–¥–µ–æ).
- –î–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç—á–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ REST API (`/api/pos-report`).

---

### 8. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä**:
   ```bash
   export TRASSIR_HOST=192.168.109.181
   export TRASSIR_USER_LOGIN=prisma
   export TRASSIR_USER_PASSWORD=prisma
   export TRASSIR_PASS=12345
   node server.js
   ```
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª—ã**:
   ```bash
   curl "http://localhost:3000/api/pos-terminals"
   ```
   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤.
3. **–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ —Å–æ–±—ã—Ç–∏—è**:
   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WebSocket-–∫–ª–∏–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, Postman –∏–ª–∏ –∫–æ–¥ –≤—ã—à–µ) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:
   ```json
   {
     "type": "subscribe-pos-events",
     "params": {
       "terminal": "G7D1uymM"
     }
   }
   ```
   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –ø–æ—Å—Ç—É–ø–∞—é—Ç –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ.
4. **–°–æ–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é**:
   –ù–∞ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É.
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∏–¥–µ–æ**:
   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –¥–ª—è –∫–∞–º–µ—Ä—ã —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å —Å–æ–±—ã—Ç–∏—è–º–∏.

---

### 9. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π
- **–ù–µ—Ç POS-—Å–æ–±—ã—Ç–∏–π**:
  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –≤ TRASSIR (IP, –ø–æ—Ä—Ç, –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
  - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ POS-—Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∂—É—Ä–Ω–∞–ª TRASSIR).
  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `curl "https://192.168.109.181:8080/pos_events?sid=<SID>"`.
- **–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**:
  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —É–∫–∞–∑–∞–Ω –ª–∏ `channel` —É —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (`getPosTerminals`).
  - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ `/get_video`.
  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ FFmpeg –Ω–∞ –æ—à–∏–±–∫–∏ (`I/O error`, `Stream ends prematurely`).
- **–û—à–∏–±–∫–∏ `Invalid SID`**:
  - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `prisma` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ `/pos_events`.
  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `TRASSIR_USER_LOGIN` –∏ `TRASSIR_USER_PASSWORD`.
- **–û—à–∏–±–∫–∏ `503`**:
  - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä TRASSIR (—á–µ—Ä–µ–∑ `/health`).
  - –£–º–µ–Ω—å—à–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É –æ–ø—Ä–æ—Å–∞ (`POS_EVENTS_POLL_INTERVAL_MS=2000`).
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
  - –í–∫–ª—é—á–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `startPosEventsStream` –∏ `launchVideoStream` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

---

### 10. –ü–æ–ª–Ω—ã–π –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–¥–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ó–∞–º–µ–Ω–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —á–∞—Å—Ç–∏ –≤ –≤–∞—à–µ–º `server.js`.

```javascript
// ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ...

class TrassirClient {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã ...

  async getPosTerminals() {
    try {
      const response = await this.sdkRequest({
        endpoint: '/objects',
        sidType: 'user'
      });
      const terminals = response.filter(obj => obj?.class === 'PosTerminal');
      return terminals.map(terminal => ({
        guid: terminal.guid,
        name: terminal.name || terminal.guid,
        ip: terminal.ip,
        port: terminal.port,
        channel: terminal.channel
      }));
    } catch (error) {
      throw createError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ POS-—Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤', error);
    }
  }

  async searchPosReceipts(params = {}) {
    return this.sdkRequest({
      endpoint: '/pos_receipts',
      params: { ...params, format: 'json' },
      sidType: 'user'
    });
  }

  async getPosReport(params = {}) {
    return this.sdkRequest({
      endpoint: '/pos_report',
      params: { ...params, format: 'json' },
      sidType: 'user'
    });
  }

  async sdkRequest(options, attempt = 0) {
    const {
      endpoint,
      method = 'GET',
      params = {},
      data,
      responseType = 'text',
      sidType = 'sdk',
      skipParse = false
    } = options;

    let mergedParams = { ...params };
    let sid = null;
    if (sidType) {
      sid = await this.ensureSid(sidType);
      mergedParams = { ...mergedParams, sid };
    }

    try {
      const response = await this.axios.request({
        url: endpoint,
        method,
        params: mergedParams,
        data,
        responseType
      });

      if (responseType === 'arraybuffer' || skipParse) {
        return response.data;
      }

      return tryParseJson(response.data);
    } catch (error) {
      if (sidType && this.isInvalidSidError(error) && attempt === 0) {
        this.invalidateSid(sidType);
        return this.sdkRequest(options, attempt + 1);
      }
      if (endpoint === '/pos_events' && error.response?.status === 503) {
        throw createError('–°–µ—Ä–≤–µ—Ä ActivePOS –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', error);
      }
      throw error;
    }
  }
}

async function startPosEventsStream(ws, params = {}) {
  stopPosEventsStream(ws);

  const state = {
    cancelled: false,
    pending: false,
    timer: null,
    lastLogAt: 0,
    lastEventTimestamp: params.lastEventTimestamp || 0
  };

  posEventStreams.set(ws, state);

  const rawInterval = Number(params.pollInterval);
  const pollIntervalBase = Number.isFinite(rawInterval) && rawInterval >= 0
    ? rawInterval
    : POS_EVENTS_POLL_INTERVAL_MS;
  const pollInterval = Math.max(pollIntervalBase, 100);
  const requestParams = { ...params };
  delete requestParams.pollInterval;
  delete requestParams.lastEventTimestamp;

  if (requestParams.terminal) {
    try {
      const terminals = await trassir.getPosTerminals();
      const terminal = terminals.find(t => t.guid === requestParams.terminal);
      if (terminal?.channel) {
        await startVideoStream(ws, terminal.channel);
        console.log(`üé• –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ${requestParams.terminal} (–∫–∞–º–µ—Ä–∞: ${terminal.channel})`);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:', error.message);
    }
  }

  console.log('üßæ ActivePOS: –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞', {
    ...requestParams,
    pollInterval
  });

  const poll = async () => {
    if (state.cancelled || ws.readyState !== WebSocket.OPEN) {
      return;
    }

    if (state.pending) {
      state.timer = setTimeout(poll, pollInterval);
      return;
    }

    state.pending = true;
    let retryCount = 0;
    const maxRetries = 3;

    const attemptPoll = async () => {
      try {
        const response = await trassir.getActivePosEvents(requestParams);
        let events = Array.isArray(response) ? response : Array.isArray(response?.data) ? response.data : [];

        events = events.filter(event => {
          if (!event.event_timestamp) return true;
          const timestamp = Number(event.event_timestamp);
          return timestamp > state.lastEventTimestamp;
        });

        events.sort((a, b) => Number(a.event_timestamp || 0) - Number(b.event_timestamp || 0));

        const enrichedEvents = await Promise.all(events.map(async event => {
          if (event.pos_terminal && videoStreamsByGuid.has(event.pos_terminal)) {
            const videoStream = videoStreamsByGuid.get(event.pos_terminal);
            return {
              ...event,
              video: {
                streamId: videoStream.id,
                wsPort: VIDEO_WS_PORT,
                container: videoStream.container,
                timestamp: event.event_timestamp
              }
            };
          }
          return event;
        }));

        if (enrichedEvents.length && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'pos-events',
            data: enrichedEvents
          }));

          const lastEvent = enrichedEvents[enrichedEvents.length - 1];
          if (lastEvent?.event_timestamp) {
            state.lastEventTimestamp = Number(lastEvent.event_timestamp);
          }
        }

        const now = Date.now();
        const shouldLog =
          enrichedEvents.length > 0 ||
          now - state.lastLogAt >= Math.max(pollInterval * 10, 10_000);
        if (shouldLog) {
          state.lastLogAt = now;
          console.log('üßæ ActivePOS: –æ—Ç–≤–µ—Ç', {
            channel: requestParams.channel,
            events: enrichedEvents.length,
            lastEventTimestamp: state.lastEventTimestamp,
            pollInterval
          });
        }
      } catch (error) {
        if (error.message.includes('–°–µ—Ä–≤–µ—Ä ActivePOS –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω') && retryCount < maxRetries) {
          retryCount++;
          console.warn(`‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è POS —Å–æ–±—ã—Ç–∏–π (${retryCount}/${maxRetries})`);
          await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
          return attemptPoll();
        }
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è POS —Å–æ–±—ã—Ç–∏–π:', error.message);
        if (trassir.isInvalidSidError(error)) {
          trassir.invalidateSid('user');
        }
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'error',
            message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è ActivePOS',
            details: error.message
          }));
        }
      }
    };

    await attemptPoll();
    state.pending = false;
    if (!state.cancelled) {
      state.timer = setTimeout(poll, pollInterval);
    }
  };

  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'stream',
      mode: 'pos-events',
      params: requestParams,
      lastEventTimestamp: state.lastEventTimestamp
    }));
  }

  poll();
}

// ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ...

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ REST API –¥–ª—è ActivePOS
app.get('/api/pos-terminals', handleRoute(async () => {
  return trassir.getPosTerminals();
}));

app.get('/api/pos-receipts', handleRoute(async (req) => {
  return trassir.searchPosReceipts(req.query);
}));

app.get('/api/pos-report', handleRoute(async (req) => {
  return trassir.getPosReport(req.query);
}));
```

---

### –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ActivePOS –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑:
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `TrassirClient` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤, —á–µ–∫–æ–≤ –∏ –æ—Ç—á–µ—Ç–æ–≤.
- –£–ª—É—á—à–µ–Ω–∏–µ `startPosEventsStream` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤–∏–¥–µ–æ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ REST API –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º ActivePOS.
- –ü–æ–¥–¥–µ—Ä–∂–∫—É –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –∏ –≤–∏–¥–µ–æ.

